import*as THREE from"../a/a.js";export{THREE};export async function loadRGBELoader(){return{RGBELoader:RGBELoader,default:RGBELoader}}export async function loadGLTFLoader(){const t=await import("./a.js");return t.GLTFLoader||t.default||t}export function generateWorldFromWorkerLogic(t,e,i){function s(t){const e=2147483647;let i=t||1;return()=>(i=16807*i%e,i/e)}class o{constructor(t){this.levels=t,this.fuzz=16,this.seed=Math.floor(2147483647*Math.random())}read(t,e){const i=s(this.seed),o=new Int32Array(t*e);let r=this.levels,n=t>>r;for(let s=0;s<e;s+=n)for(let e=0;e<t;e+=n)o[e+s*t]=(Math.floor(256*i())-128)*this.fuzz;for(;n>1;){const s=256*(n<<r),a=Math.floor(n/2);for(let r=0;r<e;r+=n)for(let h=0;h<t;h+=n){const l=o[(h+0)%t+(r+0)%e*t],c=o[(h+n)%t+(r+0)%e*t],d=o[(h+0)%t+(r+n)%e*t],u=o[(h+n)%t+(r+n)%e*t],f=Math.floor((l+d+c+u)/4)+Math.floor(i()*s*2)-s;o[h+a+(r+a)*t]=f}for(let r=0;r<e;r+=n)for(let h=0;h<t;h+=n){const l=o[h+r*t],c=o[(h+n)%t+r*t],d=o[h+(r+n)%e*t],u=o[(h+a&t-1)+(r+a-n&e-1)*t],f=o[(h+a-n&t-1)+(r+a&e-1)*t],m=o[(h+a)%t+(r+a)%e*t],p=Math.floor((l+c+m+u)/4)+Math.floor(i()*s*2)-s,g=Math.floor((l+d+m+f)/4)+Math.floor(i()*s*2)-s;o[h+a+r*t]=p,o[h+(r+a)*t]=g}n=Math.floor(n/2)}const a=new Int32Array(t*e);for(let i=0;i<e;i++)for(let s=0;s<t;s++)a[s+i*t]=Math.floor(o[s%t+i%e*t]/512)+128;return a}}const r=t||256,n=e||256,a=i||64,h=new Uint8Array(r*a*n),l=new Uint8Array(r*n),c=new o(0).read(r,n),d=new o(0).read(r,n),u=new o(1).read(r,n),f=new o(1).read(r,n);for(let t=0;t<r;t++)for(let e=0;e<n;e++){let i=c[t+e*r],s=d[t+e*r];u[t+e*r]<128&&(s=i);const o=Math.max(i,s);let n=Math.min(a-1,Math.floor(o/8)+Math.floor(a/3)),l=Math.floor(f[t+e*r]/8)+Math.floor(a/3);l>n-2&&(l=n-2);const m=30,p=Math.min(Math.floor(a/3),m);n<=p&&(n=p+1);for(let i=0;i<a;i++){const s=a-1-i,o=t+s*r+e*(r*a);let c=0;0!==s?(s===n&&s>p?c=9:s<n&&s>=l?c=2:s<l&&(c=1),h[o]=c):h[o]=1}}const m=Math.floor(r*n*a/256/64),p=s(Date.now());for(let t=0;t<m;t++){let t=p()*r,e=p()*a,i=p()*n;const s=Math.floor(p()+150*p());let o=p()*Math.PI*2,l=0,c=p()*Math.PI*2,d=0;for(let u=0;u<s;u++){t+=Math.sin(o)*Math.cos(c),i+=Math.cos(o)*Math.cos(c),e+=Math.sin(c),o+=.2*l,l*=.9,l+=p()-p(),c+=.5*d,c*=.5,d*=.9,d+=p()-p();const f=2.5*Math.sin(u*Math.PI/s)+1;for(let s=Math.floor(t-f);s<=Math.floor(t+f);s++)for(let o=Math.floor(e-f);o<=Math.floor(e+f);o++)for(let l=Math.floor(i-f);l<=Math.floor(i+f);l++){const c=s-t,d=o-e,u=l-i;if(c*c+d*d*2+u*u<f*f&&s>=1&&o>=1&&l>=1&&s<r-1&&o<a-1&&l<n-1){const t=s+o*r+l*(r*a);1===h[t]&&(h[t]=0)}}}}try{const t=new Uint8Array(r*n);for(let e=0;e<r;e++)for(let i=0;i<n;i++){let s=-1;for(let t=a-1;t>=0;t--)if(0!==h[e+t*r+i*(r*a)]){s=t;break}if(s>=0){const o=e+i*r;1===h[e+s*r+i*(r*a)]&&(t[o]=1)}}const e=new Uint8Array(r*n),i=[];for(let s=0;s<r;s++)for(let o=0;o<n;o++){const l=s+o*r;if(!t[l]||e[l])continue;let c=0;i.length=0,e[l]=1,i.push([s,o]);const d=[];let u=s,f=s,m=o,p=o;for(;i.length;){const[s,o]=i.pop();if(!t[s+o*r])continue;c++,d.push([s,o]),s<u&&(u=s),s>f&&(f=s),o<m&&(m=o),o>p&&(p=o);const a=[[1,0],[-1,0],[0,1],[0,-1]];for(const[h,l]of a){const a=s+h,c=o+l;if(a<0||c<0||a>=r||c>=n)continue;const d=a+c*r;!e[d]&&t[d]&&(e[d]=1,i.push([a,c]))}}if(c>=10||f-u+1>=10)for(const[t,e]of d)for(let i=a-1;i>=0;i--){const s=t+i*r+e*(r*a);if(0!==h[s]){1===h[s]&&(h[s]=9);break}}}}catch(t){}for(let t=0;t<r;t++)for(let e=0;e<n;e++){let i;for(i=a-1;i>=0&&0===h[t+i*r+e*(r*a)];--i);l[t+e*r]=i<0?-1:a-1-i}return{blocks:h,lightDepths:l,width:r,height:n,depth:a}}export class World{constructor(t,e){this.width=256,this.height=256,this.depth=64,this.blocks=null,this.lightDepths=null,this.blockMaterials=t,this.materialIndexMap=e,this._grassDirty=new Set,this.loadedChunkMeshes=new Map,this.chunkSizeX=16,this.chunkSizeY=this.depth,this.chunkSizeZ=16,window.worldInstance||(window.worldInstance=this)}worldIndex(t,e,i){return t<0||t>=this.width||i<0||i>=this.height||e<0||e>=this.depth?-1:t+(this.depth-1-e)*this.width+i*this.width*this.depth}async init(){try{if(window._preventLocalGeneration&&this.blocks&&this.blocks.length===this.width*this.height*this.depth)return void("function"==typeof this.onReady&&this.onReady());try{const t=(location.hash||"").slice(1);if(t&&(t.startsWith("JOIN")||t.length>0)){const e=t.replace(/^JOIN/,"").trim();if(e&&window.P2PNetwork&&"function"==typeof window.P2PNetwork.connectTo){await window.P2PNetwork.init();const t=e.startsWith("minecraft4k-")?e:`minecraft4k-${e}`;try{await window.P2PNetwork.connectTo(t)}catch(t){console.warn("[World] connectTo host failed",t)}window.P2PNetwork.onIncoming(((t,e)=>{try{if(!e||"object"!=typeof e)return;if("world_state"===e.type&&e.blocks)this.width=e.width||this.width,this.height=e.height||this.height,this.depth=e.depth||this.depth,this.blocks=e.blocks instanceof Uint8Array?e.blocks:new Uint8Array(e.blocks),this.lightDepths=e.lightDepths?e.lightDepths instanceof Uint8Array?e.lightDepths:new Uint8Array(e.lightDepths):new Uint8Array(this.width*this.height),console.log("[World] received world_state from host",t),"function"==typeof this.onReady&&this.onReady();else if("player_update"===e.type&&e.players){window.peersLive=window.peersLive||{};for(const t of e.players)t&&t.id&&(window.peersLive[t.id]=t)}else"player_model"===e.type&&e.id&&e.model&&(window.peersLive=window.peersLive||{},window.peersLive[e.id]=window.peersLive[e.id]||{},window.peersLive[e.id].model=e.model)}catch(t){console.warn("[World] error processing incoming p2p payload",t)}}));const i=this.width*this.height*this.depth;this.blocks||=new Uint8Array(i),this.lightDepths||=new Uint8Array(this.width*this.height);try{await window.P2PNetwork.sendTo(t,{type:"request_world"})}catch(t){}return}}}catch(t){}if(window.websimRoom&&"function"==typeof window.websimRoom.collection){const t=window.websimRoom.collection("world_master");if(t)try{const e=t.getList?t.getList():[];if(Array.isArray(e)&&e.length>0&&e[0].blocks){const t=e[0];return this.width=t.width||this.width,this.height=t.height||this.height,this.depth=t.depth||this.depth,this.blocks=new Uint8Array(t.blocks),this.lightDepths=new Uint8Array(t.lightDepths||new Array(this.width*this.height).fill(0)),void console.log("Loaded shared master world from Websim.")}{const t=this.width*this.height*this.depth;return this.blocks=new Uint8Array(t),this.lightDepths=new Uint8Array(this.width*this.height),void console.log("No shared master world found; initialized empty world and awaiting server-side generation.")}}catch(t){console.warn("Failed to read world_master collection; falling back to empty world",t);const e=this.width*this.height*this.depth;return this.blocks=new Uint8Array(e),void(this.lightDepths=new Uint8Array(this.width*this.height))}}}catch(t){}return new Promise(((t,e)=>{let i;try{i=new Worker("../b/a.js",{type:"module"})}catch(t){return console.error("Failed to start worker",t),void e(t)}i.postMessage({width:this.width,height:this.height,depth:this.depth}),i.onmessage=e=>{try{this.blocks=new Uint8Array(e.data.blocks),this.lightDepths=new Uint8Array(e.data.lightDepths)}finally{try{i.terminate()}catch(t){}}try{const t=Tiles.bedrock&&Tiles.bedrock.id?Tiles.bedrock.id:8,e=Tiles.stone&&Tiles.stone.id?Tiles.stone.id:1,i=Tiles.grass&&Tiles.grass.id?Tiles.grass.id:9;let s=!1;for(let e=0;e<this.width&&!s;e++)for(let i=0;i<this.depth&&!s;i++)for(let o=0;o<this.height;o++){const r=this.worldIndex(e,i,o);if(r>=0&&this.blocks[r]===t){s=!0;break}}if(s)for(let s=0;s<this.width;s++)for(let o=0;o<this.depth;o++)for(let r=0;r<this.height;r++){const n=this.worldIndex(s,o,r);-1!==n&&this.blocks[n]===t&&(this.blocks[n]=o===this.depth-1?i:e)}}catch(t){console.warn("bedrock cleanup failed",t)}try{applySeedFeatures(this,window._world_seed||2147483647&Date.now())}catch(t){console.warn("seed features apply failed",t)}try{const t=Tiles&&Tiles.stone&&Tiles.stone.id?Tiles.stone.id:1,e=Tiles&&Tiles.grass&&Tiles.grass.id?Tiles.grass.id:9,i=Tiles&&Tiles.bedrock&&Tiles.bedrock.id?Tiles.bedrock.id:8,s=Math.floor(.65*this.depth);for(let o=0;o<this.width;o++)for(let r=0;r<this.height;r++){let n=-1;for(let t=this.depth-1;t>=0;t--)if(0!==this.getTile(o,t,r)){n=t;break}const a=Math.min(this.depth-1,Math.max(0,n+1));if(a>=s){const t=this.worldIndex(o,a,r);-1!==t&&0===this.blocks[t]&&(this.blocks[t]=e)}for(let s=0;s<this.depth;s++){const n=this.worldIndex(o,s,r);-1!==n&&this.blocks[n]===i&&(this.blocks[n]=s===this.depth-1?e:t)}}}catch(t){console.warn("surface post-process failed",t)}if("function"==typeof this.onReady)try{this.onReady()}catch(t){}t()},i.onerror=t=>{console.error("WGW.js worker encountered an error:",t);try{i.terminate()}catch(t){}e(t)}}))}getTile(t,e,i){const s=this.worldIndex(t,e,i);return-1===s?Tiles.bedrock&&Tiles.bedrock.id?Tiles.bedrock.id:8:this.blocks[s]}setTile(t,e,i,s){const o=this.worldIndex(t,e,i);o<0||(this.blocks[o]=0|s)}getGroundHeight(t,e){let i=this.depth-1;for(;i>=0;i--)if(0!==this.getTile(t,i,e))return i;return-1}getBrightness(t,e,i,s){let o=t,r=e,n=i;switch(s){case 0:r+=1;break;case 1:r-=1;break;case 2:n-=1;break;case 3:n+=1;break;case 4:o+=1;break;case 5:o-=1;break;default:return{finalBrightness:1,isSunlit:!0}}if(o<0||o>=this.width||r<0||r>=this.depth||n<0||n>=this.height)return{finalBrightness:1,isSunlit:!0};let a,h=!0;o<0||o>=this.width||n<0||n>=this.height?(a=1,h=!0):this.getGroundHeight(o,n)>r?(a=.5,h=!1):(a=1,h=!0);let l=a;return 2===s||3===s?l*=.8:4!==s&&5!==s||(l*=.6),{finalBrightness:Math.max(0,Math.min(1,l)),isSunlit:h}}buildChunkMesh(t,e){const i=[],s=[],o=[],r=[],n=[],a=[],h=[],l=[],c=[];let d=0;const u=(t,e,i)=>2===i&&0===e||3===i&&e===this.height-1||4===i&&t===this.width-1||5===i&&0===t,f=(t,e,f,m,p)=>{const g=Tiles.byId[p];if(!g)return;if(6===g.id){const u={value:d};return renderBush(this,t,e,f,{allPositions:i,allNormals:s,allUvs:o,allColors:r,allIndices:n,allIsSunlit:a,allIsSideBoundaryFace:h,allIsBottomBoundaryFace:l,faceGroupInfo:c,vertexCountRef:u},this.materialIndexMap),void(d=u.value)}let y=g.getTextureKey(m);if(null==y){const i=this.getTile(t,e-1,f),s=Tiles.byId[i];y=s?s.getTextureKey(m):null}const w=this.materialIndexMap[y];if(void 0===w)return void console.warn(`No material for texture key: ${y}`);let b,M;switch(m){case 0:b=[t,e+1,f+1,t+1,e+1,f+1,t,e+1,f,t+1,e+1,f],M=[0,1,0,0,1,0,0,1,0,0,1,0];break;case 1:b=[t,e,f,t+1,e,f,t,e,f+1,t+1,e,f+1],M=[0,-1,0,0,-1,0,0,-1,0,0,-1,0];break;case 2:b=[t,e,f,t+1,e,f,t,e+1,f,t+1,e+1,f],M=[0,0,-1,0,0,-1,0,0,-1,0,0,-1];break;case 3:b=[t+1,e,f+1,t,e,f+1,t+1,e+1,f+1,t,e+1,f+1],M=[0,0,1,0,0,1,0,0,1,0,0,1];break;case 4:b=[t+1,e,f,t+1,e,f+1,t+1,e+1,f,t+1,e+1,f+1],M=[1,0,0,1,0,0,1,0,0,1,0,0];break;case 5:b=[t,e,f+1,t,e,f,t,e+1,f+1,t,e+1,f],M=[-1,0,0,-1,0,0,-1,0,0,-1,0,0]}const x=u(t,f,m),T=0===e&&1===m,E=this.getBrightness(t,e,f,m),A=E.finalBrightness,S=E.isSunlit,_=n.length,R=[],k=[],v=[],B=[];for(let t=0;t<4;t++)R.push(A,A,A),k.push(S?1:0),v.push(x?1:0),B.push(T?1:0);i.push(...b),s.push(...M),o.push(0,0,1,0,0,1,1,1),r.push(...R),a.push(...k),h.push(...v),l.push(...B),n.push(d,d+2,d+1,d+1,d+2,d+3),c.push({materialIndex:w,start:_,count:6}),d+=4},m=t*this.chunkSizeX,p=Math.min((t+1)*this.chunkSizeX,this.width),g=e*this.chunkSizeZ,y=Math.min((e+1)*this.chunkSizeZ,this.height);for(let t=m;t<p;t++)for(let e=0;e<this.depth;e++)for(let m=g;m<y;m++){const p=this.getTile(t,e,m);if(0!==p)if(6!==p)0===this.getTile(t,e+1,m)&&f(t,e,m,0,p),(0===this.getTile(t,e-1,m)||0===e&&0===this.getTile(t,e-1,m))&&f(t,e,m,1,p),(0===this.getTile(t,e,m-1)||u(t,m,2))&&f(t,e,m,2,p),(0===this.getTile(t,e,m+1)||u(t,m,3))&&f(t,e,m,3,p),(0===this.getTile(t+1,e,m)||u(t,m,4))&&f(t,e,m,4,p),(0===this.getTile(t-1,e,m)||u(t,m,5))&&f(t,e,m,5,p);else{const u={value:d};renderBush(this,t,e,m,{allPositions:i,allNormals:s,allUvs:o,allColors:r,allIndices:n,allIsSunlit:a,allIsSideBoundaryFace:h,allIsBottomBoundaryFace:l,faceGroupInfo:c,vertexCountRef:u},this.materialIndexMap),d=u.value}}const w=new THREE.BufferGeometry;w.setAttribute("position",new THREE.Float32BufferAttribute(i,3)),w.setAttribute("normal",new THREE.Float32BufferAttribute(s,3)),w.setAttribute("uv",new THREE.Float32BufferAttribute(o,2)),w.setAttribute("color",new THREE.Float32BufferAttribute(r,3)),w.setAttribute("isSunlit",new THREE.Float32BufferAttribute(a,1)),w.setAttribute("isSideBoundaryFace",new THREE.Float32BufferAttribute(h,1)),w.setAttribute("isBottomBoundaryFace",new THREE.Float32BufferAttribute(l,1)),w.setIndex(n);let b=-1,M=0,x=0;for(const t of c)t.materialIndex!==b?(x>0&&w.addGroup(M,x,b),b=t.materialIndex,M=t.start,x=t.count):x+=t.count;return x>0&&w.addGroup(M,x,b),new THREE.Mesh(w,this.blockMaterials)}loadChunk(t,e,i){const s=`${t}_${e}`;if(this.loadedChunkMeshes.has(s))return;const o=this.buildChunkMesh(t,e);i.add(o),this.loadedChunkMeshes.set(s,o)}unloadChunk(t,e,i){const s=`${t}_${e}`,o=this.loadedChunkMeshes.get(s);o&&(i.remove(o),o.geometry.dispose(),this.loadedChunkMeshes.delete(s))}isLit(t,e,i){return t<0||t>=this.width||i<0||i>=this.height||e<0||e>=this.depth||e>=this.lightDepths[t+i*this.width]}updateBlockAndLight(t,e,i){let s;for(s=this.depth-1;s>=0&&0===this.getTile(t,s,i);--s);this.lightDepths[t+i*this.width]=s;try{this._grassDirty.add(`${t}_${i}`)}catch(t){}try{const e=`${Math.floor(t/this.chunkSizeX)}_${Math.floor(i/this.chunkSizeZ)}`;if(this.loadedChunkMeshes.has(e)){const t=this.loadedChunkMeshes.get(e);t.userData._needsRebuild=!0,t.userData._doubleRebuild=!0}}catch(t){}}getCubes(t){const e=[],i=Math.max(0,Math.floor(t.minX)-1),s=Math.min(this.width,Math.ceil(t.maxX)+1),o=Math.max(0,Math.floor(t.minY)-1),r=Math.min(this.depth,Math.ceil(t.maxY)+1),n=Math.max(0,Math.floor(t.minZ)-1),a=Math.min(this.height,Math.ceil(t.maxZ)+1);for(let t=i;t<s;t++)for(let i=o;i<r;i++)for(let s=n;s<a;s++)0!==this.getTile(t,i,s)&&e.push(new AABB(t,i,s,t+1,i+1,s+1));return e}processBushTicks(){const t=Tiles.dirt.id,e=Tiles.grass.id;for(const i of this.loadedChunkMeshes.keys()){const[s,o]=i.split("_").map(Number),r=s*this.chunkSizeX,n=Math.min((s+1)*this.chunkSizeX,this.width),a=o*this.chunkSizeZ,h=Math.min((o+1)*this.chunkSizeZ,this.height);for(let i=r;i<n;i++)for(let r=a;r<h;r++)for(let n=0;n<this.depth;n++){if(6!==this.getTile(i,n,r))continue;const a=this.getTile(i,n-1,r);if(!this.isLit(i,n,r)||a!==t&&a!==e){this.setTile(i,n,r,0),this.updateBlockAndLight(i,n,r);const e=`${s}_${o}`;this.loadedChunkMeshes.has(e)&&(this.loadedChunkMeshes.get(e).userData._needsRebuild=!0);try{this._bushProtected&&this._bushProtected.delete(`${i}_${n-1}_${r}`)}catch(t){}}}}}processGrassGrowth(t,e=new Map,i){if(!(e instanceof Map))try{e=e&&"object"==typeof e?new Map(Object.entries(e)):new Map}catch(t){e=new Map}if(void 0!==i&&!(i instanceof Map))try{i=i&&"object"==typeof i?new Map(Object.entries(i)):new Map}catch(t){i=new Map}const s=Tiles.dirt&&Tiles.dirt.id?Tiles.dirt.id:2,o=Tiles.grass&&Tiles.grass.id?Tiles.grass.id:9,r=[];if(this._grassDirty&&this._grassDirty.size>0){for(const t of this._grassDirty){const[e,i]=t.split("_").map(Number);Number.isFinite(e)&&Number.isFinite(i)&&r.push([e,i])}this._grassDirty.clear()}else for(const t of this.loadedChunkMeshes.keys()){const[e,i]=t.split("_").map(Number);r.push([e,i])}for(const[n,a]of r){const r=n*this.chunkSizeX,h=Math.min((n+1)*this.chunkSizeX,this.width),l=a*this.chunkSizeZ,c=Math.min((a+1)*this.chunkSizeZ,this.height);for(let d=r;d<h;d++)for(let r=l;r<c;r++){const h=this.getGroundHeight(d,r);if(!(h<0))for(let l=h;l>=Math.max(0,h-2);l--){if(this.getTile(d,l,r)!==s)continue;if(0!==this.getTile(d,l+1,r))continue;if(!(l+1>=this.lightDepths[d+r*this.width])){const t=`${d}_${l}_${r}`;e.has(t)&&e.delete(t);continue}const h=`${d}_${l}_${r}`,c=(e.get(h)||0)+t;if(c>=.5){this.setTile(d,l,r,o),this.updateBlockAndLight(d,l,r),e.delete(h);const t=`${n}_${a}`;if(this.loadedChunkMeshes.has(t)){const e=this.loadedChunkMeshes.get(t);e.userData._needsRebuild=!0,e.userData._doubleRebuild=!0}i&&i.has(h)&&i.delete(h)}else e.set(h,c)}}}if(e&&"function"==typeof e.entries)for(const[t,i]of Array.from(e.entries())){const[i,o,r]=t.split("_").map(Number);this.getTile(i,o,r)===s&&0===this.getTile(i,o+1,r)||e.delete(t)}if(i)for(const e of this.loadedChunkMeshes.keys()){const[r,n]=e.split("_").map(Number),a=r*this.chunkSizeX,h=Math.min((r+1)*this.chunkSizeX,this.width),l=n*this.chunkSizeZ,c=Math.min((n+1)*this.chunkSizeZ,this.height);for(let e=a;e<h;e++)for(let a=l;a<c;a++){const h=this.getGroundHeight(e,a);if(!(h<0))for(let l=h;l>=Math.max(0,h-3);l--){const h=`${e}_${l}_${a}`;if(this.getTile(e,l,a)!==o){i.has(h)&&i.delete(h);continue}let c=!1;for(let t=l+1;t<this.depth;t++)if(0!==this.getTile(e,t,a)){c=!0;break}if(c){const o=(i.get(h)||0)+t;if(o>=2.5){if(this._bushProtected&&this._bushProtected.has(h)){i.delete(h);continue}this.setTile(e,l,a,s),this.updateBlockAndLight(e,l,a),i.delete(h);const t=`${r}_${n}`;if(this.loadedChunkMeshes.has(t)){const e=this.loadedChunkMeshes.get(t);e.userData._needsRebuild=!0,e.userData._doubleRebuild=!0}}else i.set(h,o)}else i.has(h)&&i.delete(h)}}}}async saveToDB(){try{if(!window.websimRoom||!window.websim)return!1;const t=await window.websim.getCurrentUser();if(!t||!t.username)return!1;const e=window.websimRoom.collection("world");if(!e)return!1;const i=window.player&&"number"==typeof window.player.x?{player_x:window.player.x,player_y:window.player.y,player_z:window.player.z,player_yaw:window.player.yRotation,player_pitch:window.player.xRotation}:{},s={username:t.username,width:this.width,height:this.height,depth:this.depth,blocks:Array.from(this.blocks||[]),lightDepths:Array.from(this.lightDepths||[]),created_at:(new Date).toISOString(),...i};let o=[];try{o=e.filter({username:t.username}).getList()}catch(t){}return Array.isArray(o)&&o.length>0?await e.update(o[0].id,s).catch((async()=>{await e.create(s).catch((()=>{}))})):await e.create(s).catch((()=>{})),!0}catch(t){return!1}}}export{GLTFLoader}from"./a.js";export class RGBELoader extends THREE.DataTextureLoader{constructor(t){super(t),this.type=THREE.HalfFloatType}parse(t){const e=(t,e)=>{switch(t){case 1:throw new Error("THREE.RGBELoader: Read Error: "+(e||""));case 2:throw new Error("THREE.RGBELoader: Write Error: "+(e||""));case 3:throw new Error("THREE.RGBELoader: Bad File Format: "+(e||""));default:throw new Error("THREE.RGBELoader: Memory Error: "+(e||""))}},i=(t,e=1024,i=!0)=>{let s=t.pos,o=0,r="",n=String.fromCharCode.apply(null,new Uint16Array(t.subarray(s,s+128))),a=-1;for(;(a=n.indexOf("\n"))<0&&o<e&&s<t.byteLength;)r+=n,o+=n.length,s+=128,n+=String.fromCharCode.apply(null,new Uint16Array(t.subarray(s,s+128)));return a>-1?(!1!==i&&(t.pos+=o+a+1),r+n.slice(0,a)):null},s=(t,e,i,s)=>{const o=t[e+3],r=Math.pow(2,o-128)/255;i[s+0]=t[e+0]*r,i[s+1]=t[e+1]*r,i[s+2]=t[e+2]*r,i[s+3]=1},o=(t,e,i,s)=>{const o=t[e+3],r=Math.pow(2,o-128)/255;i[s+0]=THREE.DataUtils.toHalfFloat(Math.min(t[e+0]*r,65504)),i[s+1]=THREE.DataUtils.toHalfFloat(Math.min(t[e+1]*r,65504)),i[s+2]=THREE.DataUtils.toHalfFloat(Math.min(t[e+2]*r,65504)),i[s+3]=THREE.DataUtils.toHalfFloat(1)},r=new Uint8Array(t);r.pos=0;const n=(t=>{const s=/^\s*GAMMA\s*=\s*(\d+(\.\d+)?)\s*$/,o=/^\s*EXPOSURE\s*=\s*(\d+(\.\d+)?)\s*$/,r=/^\s*FORMAT=(\S+)\s*$/,n=/^\s*\-Y\s+(\d+)\s+\+X\s+(\d+)\s*$/,a={valid:0,string:"",comments:"",programtype:"RGBE",format:"",gamma:1,exposure:1,width:0,height:0};let h,l;for((t.pos>=t.byteLength||!(h=i(t)))&&e(1,"no header found"),(l=h.match(/^#\?(\S+)/))||e(3,"bad initial token"),a.valid|=1,a.programtype=l[1],a.string+=h+"\n";null!==(h=i(t));)if(a.string+=h+"\n","#"!==h.charAt(0)){if((l=h.match(s))&&(a.gamma=parseFloat(l[1])),(l=h.match(o))&&(a.exposure=parseFloat(l[1])),(l=h.match(r))&&(a.valid|=2,a.format=l[1]),(l=h.match(n))&&(a.valid|=4,a.height=parseInt(l[1],10),a.width=parseInt(l[2],10)),2&a.valid&&4&a.valid)break}else a.comments+=h+"\n";return 2&a.valid||e(3,"missing format specifier"),4&a.valid||e(3,"missing image size specifier"),a})(r),a=n.width,h=n.height,l=((t,i,s)=>{const o=i;if(o<8||o>32767)return new Uint8Array(t);const r=new Uint8Array(4*o*s);r.length||e(4,"unable to allocate buffer space");let n=0,a=0;const h=4*o,l=new Uint8Array(4),c=new Uint8Array(h);let d=s;for(;d>0&&a<t.byteLength;){a+4>t.byteLength&&e(1),l[0]=t[a++],l[1]=t[a++],l[2]=t[a++],l[3]=t[a++],2==l[0]&&2==l[1]||e(3,"bad rgbe scanline format"),(l[2]<<8|l[3])!==o&&e(3,"wrong scanline width");let i=0;for(;i<h&&a<t.byteLength;){let s=t[a++];const o=s>128;if(o&&(s-=128),(0===s||i+s>h)&&e(3,"bad scanline data"),o){const e=t[a++];for(let t=0;t<s;t++)c[i++]=e}else c.set(t.subarray(a,a+s),i),i+=s,a+=s}for(let t=0;t<o;t++){let e=0;r[n]=c[t+e],e+=o,r[n+1]=c[t+e],e+=o,r[n+2]=c[t+e],e+=o,r[n+3]=c[t+e],n+=4}d--}return r})(r.subarray(r.pos),a,h);let c,d;switch(this.type){case THREE.FloatType:{const t=l.length/4,e=new Float32Array(4*t);for(let i=0;i<t;i++)s(l,4*i,e,4*i);c=e,d=THREE.FloatType;break}case THREE.HalfFloatType:{const t=l.length/4,e=new Uint16Array(4*t);for(let i=0;i<t;i++)o(l,4*i,e,4*i);c=e,d=THREE.HalfFloatType;break}default:throw new Error("THREE.RGBELoader: Unsupported type: "+this.type)}return{width:a,height:h,data:c,header:n.string,gamma:n.gamma,exposure:n.exposure,type:d}}setDataType(t){return this.type=t,this}load(t,e,i,s){return super.load(t,((t,i)=>{switch(t.type){case THREE.FloatType:case THREE.HalfFloatType:t.colorSpace=THREE.LinearSRGBColorSpace,t.minFilter=THREE.LinearFilter,t.magFilter=THREE.LinearFilter,t.generateMipmaps=!1,t.flipY=!0}e&&e(t,i)}),i,s)}}export class Cube{constructor(t=0,e=0){this.xTexOffs=t,this.yTexOffs=e,this.group=new THREE.Group,this.mesh=null,this.x=0,this.y=0,this.z=0,this.xRot=0,this.yRot=0,this.zRot=0}setPos(t,e,i){this.x=t,this.y=e,this.z=i,this.mesh&&this.group.position.set(t,e,i)}addBox(t,e,i,s,o,r){const n=new THREE.BoxGeometry(s,o,r);n.translate(t+s/2,e+o/2,i+r/2);const a=this.xTexOffs,h=this.yTexOffs,l=s,c=o,d=r,u=t=>t/64,f=t=>1-t/32,m=n.attributes.uv,p=m.array;function g(t,e,i,s,o){const r=12*t,n=u(e),a=f(i),h=u(s),l=f(o);p[r+0]=n,p[r+1]=a,p[r+2]=h,p[r+3]=a,p[r+4]=h,p[r+5]=l,p[r+6]=h,p[r+7]=l,p[r+8]=n,p[r+9]=l,p[r+10]=n,p[r+11]=a}g(0,a+d,h+d,a+d+d,h+d+c),g(1,a+d+l+d,h+d,a+d+l+d+d,h+d+c),g(2,a+d,h,a+d+l,h+d),g(3,a+d+l,h,a+d+l+l,h+d),g(4,a+d,h+d,a+d+l,h+d+c),g(5,a+d+l+d,h+d,a+d+l+d+l,h+d+c),m.needsUpdate=!0;const y=new THREE.MeshBasicMaterial({color:16777215,transparent:!0,side:THREE.DoubleSide}),w=new THREE.Mesh(n,y);w.position.set(0,0,0),this.mesh=w,this.group.add(w),this.setPos(this.x,this.y,this.z)}render(){this.mesh&&this.mesh.rotation.set(this.xRot,this.yRot,this.zRot)}}export class ZombieModel{constructor(){this.head=new Cube(0,0),this.head.addBox(-4,-8,-4,8,8,8),this.body=new Cube(16,16),this.body.addBox(-4,0,-2,8,12,4),this.arm0=new Cube(40,16),this.arm0.addBox(-3,-2,-2,4,12,4),this.arm0.setPos(-5,2,0),this.arm1=new Cube(40,16),this.arm1.addBox(-1,-2,-2,4,12,4),this.arm1.setPos(5,2,0),this.leg0=new Cube(0,16),this.leg0.addBox(-2,0,-2,4,12,4),this.leg0.setPos(-2,12,0),this.leg1=new Cube(0,16),this.leg1.addBox(-2,0,-2,4,12,4),this.leg1.setPos(2,12,0),this.group=new THREE.Group,this.group.add(this.head.group),this.group.add(this.body.group),this.group.add(this.arm0.group),this.group.add(this.arm1.group),this.group.add(this.leg0.group),this.group.add(this.leg1.group),this.group.scale.set(2,2,2)}setTexture(t,e,i){const s=i||null;if(t&&(t.magFilter=THREE.NearestFilter,t.minFilter=THREE.NearestFilter,t.wrapS=THREE.ClampToEdgeWrapping,t.wrapT=THREE.ClampToEdgeWrapping,t.offset&&t.offset.set(0,0),t.repeat&&t.repeat.set(1,1),t.flipY=!1),e&&(e.magFilter=THREE.NearestFilter,e.minFilter=THREE.NearestFilter,e.wrapS=THREE.ClampToEdgeWrapping,e.wrapT=THREE.ClampToEdgeWrapping,e.offset&&e.offset.set(0,0),e.repeat&&e.repeat.set(1,1),e.flipY=!1),s&&(s.magFilter=THREE.NearestFilter,s.minFilter=THREE.NearestFilter,s.wrapS=THREE.ClampToEdgeWrapping,s.wrapT=THREE.ClampToEdgeWrapping,s.offset&&s.offset.set(0,0),s.repeat&&s.repeat.set(1,1),s.flipY=!1),this.head&&this.head.mesh){const e=new THREE.MeshBasicMaterial({map:t||null,transparent:!0,side:THREE.DoubleSide}),i=(new THREE.MeshBasicMaterial({map:t||null,transparent:!0,side:THREE.DoubleSide}),[e,e,e,e,new THREE.MeshBasicMaterial({map:s||t||null,transparent:!0,side:THREE.DoubleSide}),e]);this.head.mesh.material=i,i.forEach((t=>{t&&t.color&&t.color.setScalar(.6),t&&(t.needsUpdate=!0)}))}[this.arm0,this.arm1].forEach((i=>{i.mesh&&(i.mesh.material.map=e||t||null,i.mesh.material.color.setScalar(.6),i.mesh.material.needsUpdate=!0)})),[this.body,this.leg0,this.leg1].forEach((e=>{e.mesh&&(e.mesh.material.map=t||null,e.mesh.material.color.setScalar(.6),e.mesh.material.needsUpdate=!0)}))}render(t){const e=12*t,i=(Math.PI,Math.PI,t=>{const e=2*Math.PI;let i=(t%e+e)%e;const s=Math.floor(i/(e/3));return 0===s?-1:1===s?0:1}),s=t;i(s),i(s+Math.PI),this.head.yRot=i(.9*e)*(20*Math.PI/180),this.head.xRot=i(1.1*e)*(20*Math.PI/180);const o=20*Math.PI/180,r=15*Math.PI/180,n=2*(45*Math.PI/180+o+Math.PI+45*Math.PI/180)-r;this.arm0.xRot=0,this.arm0.yRot=0,this.arm0.zRot=1*n,this.arm1.xRot=0,this.arm1.yRot=0,this.arm1.zRot=1*-n,this.leg0.xRot=0,this.leg1.xRot=0,[this.head,this.body,this.arm0,this.arm1,this.leg0,this.leg1].forEach((t=>{t.render()}))}}export class AABB{constructor(t,e,i,s,o,r){this.minX=t,this.minY=e,this.minZ=i,this.maxX=s,this.maxY=o,this.maxZ=r}expand(t,e,i){let s=this.minX,o=this.minY,r=this.minZ,n=this.maxX,a=this.maxY,h=this.maxZ;return t<0?s+=t:n+=t,e<0?o+=e:a+=e,i<0?r+=i:h+=i,new AABB(s,o,r,n,a,h)}move(t,e,i){this.minX+=t,this.minY+=e,this.minZ+=i,this.maxX+=t,this.maxY+=e,this.maxZ+=i}clipXCollide(t,e){if(t.maxY<=this.minY||t.minY>=this.maxY||t.maxZ<=this.minZ||t.minZ>=this.maxZ)return e;if(e>0&&t.maxX<=this.minX){const i=this.minX-t.maxX;i<e&&(e=i)}if(e<0&&t.minX>=this.maxX){const i=this.maxX-t.minX;i>e&&(e=i)}return e}clipYCollide(t,e){if(t.maxX<=this.minX||t.minX>=this.maxX||t.maxZ<=this.minZ||t.minZ>=this.maxZ)return e;if(e>0&&t.maxY<=this.minY){const i=this.minY-t.maxY;i<e&&(e=i)}if(e<0&&t.minY>=this.maxY){const i=this.maxY-t.minY;i>e&&(e=i)}return e}clipZCollide(t,e){if(t.maxX<=this.minX||t.minX>=this.maxX||t.maxY<=this.minY||t.minY>=this.maxY)return e;if(e>0&&t.maxZ<=this.minZ){const i=this.minZ-t.maxZ;i<e&&(e=i)}if(e<0&&t.minZ>=this.maxZ){const i=this.maxZ-t.minZ;i>e&&(e=i)}return e}intersects(t){return t.maxX>this.minX&&t.minX<this.maxX&&t.maxY>this.minY&&t.minY<this.maxY&&t.maxZ>this.minZ&&t.minZ<this.maxZ}}export class Entity{constructor(t){this.level=t,this.x=0,this.y=0,this.z=0,this.xo=0,this.yo=0,this.zo=0,this.xd=0,this.yd=0,this.zd=0,this.onGround=!1,this.removed=!1,this.width=0,this.height=0,this.boundingBox=null}setPos(t,e,i){this.x=t,this.y=e,this.z=i;const s=.3;this.width=s,this.height=.9,this.boundingBox=new AABB(t-s,e-.9,i-s,t+s,e+.9,i+s)}moveRelative(t,e,i){let s=Math.sqrt(t*t+e*e);s<.01||(s=i/s,t*=s,e*=s,this.xd+=t,this.zd+=e)}move(t,e,i){const s=t,o=e,r=i,n=this.boundingBox.expand(t,e,i),a=this.level.getCubes(n);for(const t of a)e=t.clipYCollide(this.boundingBox,e);this.boundingBox.move(0,e,0);for(const e of a)t=e.clipXCollide(this.boundingBox,t);this.boundingBox.move(t,0,0);for(const t of a)i=t.clipZCollide(this.boundingBox,i);this.boundingBox.move(0,0,i),this.onGround=o!==e&&o<0,s!==t&&(this.xd=0),o!==e&&(this.yd=0),r!==i&&(this.zd=0),this.x=(this.boundingBox.minX+this.boundingBox.maxX)/2,this.y=this.boundingBox.minY,this.z=(this.boundingBox.minZ+this.boundingBox.maxZ)/2}remove(){this.removed=!0}tick(){}render(t){}}export class Tile{constructor(t,e,i,s){this.id=t,this.sideTextureKey=e,this.topTextureKey=i,this.bottomTextureKey=s,this.fullCube=!0,this.breakableSides=!0}getTextureKey(t){let e;switch(t){case 0:e=this.topTextureKey;break;case 1:e=this.bottomTextureKey;break;default:e=this.sideTextureKey}return e}isSolid(){return this.id!==(Tiles.bush&&Tiles.bush.id)}isFullCube(){return!!this.fullCube}hasBreakableSides(){return!(Tiles.bedrock&&this.id===Tiles.bedrock.id||!this.breakableSides)}}export const Tiles={stone:new Tile(1,"stone","stone","stone"),dirt:new Tile(2,"dirt","dirt","dirt"),cobble:new Tile(3,"2","2","2"),wood:new Tile(4,"wood","wood","wood"),grass:new Tile(9,"grass_side","1","dirt"),bush:new Tile(6,"bush",null,null),stoneBrick:new Tile(7,"2","2","2"),byId:{},init:function(){for(const t of Object.values(this))t instanceof Tile&&(this.byId[t.id]=t)}};Tiles.init();export const BlockFaceColors={BOTTOM_FACE_MULTIPLIER:.5,TOP_FACE_MULTIPLIER:1,SIDE_FACE_MULTIPLIER:.8,END_FACE_MULTIPLIER:.6,getFaceColorMultiplier(t){switch(t){case 0:return this.TOP_FACE_MULTIPLIER;case 1:return this.BOTTOM_FACE_MULTIPLIER;case 2:case 3:return this.SIDE_FACE_MULTIPLIER;case 4:case 5:return this.END_FACE_MULTIPLIER;default:return 1}}};export const BlockColorSystem={getBlockFaceLighting(t,e,i,s,o){let r=e,n=i,a=s;switch(o){case 0:n=i+1;break;case 1:n=i-1;break;case 2:a=s-1;break;case 3:a=s+1;break;case 4:r=e+1;break;case 5:r=e-1}if(!t||r<0||r>=t.width||n<0||n>=t.depth||a<0||a>=t.height)return{finalBrightness:1,isSunlit:!0};let h=!0,l=1;try{t.getGroundHeight(r,a)>n?(l=.5,h=!1):(l=1,h=!0)}catch(t){l=1,h=!0}const c=BlockFaceColors.getFaceColorMultiplier(0===o?0:1===o?1:o);return{finalBrightness:Math.max(0,Math.min(1,l*c)),isSunlit:h}}};export function renderBush(t,e,i,s,o,r){const{allPositions:n,allNormals:a,allUvs:h,allColors:l,allIndices:c,allIsSunlit:d,allIsSideBoundaryFace:u,allIsBottomBoundaryFace:f,faceGroupInfo:m,vertexCountRef:p}=o,g=Tiles.byId[6];if(!g)return;const y=g.getTextureKey(2)||"bush-block",w=r["bush-alpha"]??r[y];if(void 0===w)return;const b=t.getTile(e,i-1,s),M=Tiles.byId[b],x=r[M?M.getTextureKey(0):null];if(void 0!==x&&0!==b){const o=BlockColorSystem.getBlockFaceLighting(t,e,i-1,s,0,b),r=o.finalBrightness,g=o.isSunlit,y=i+.01,w=[0,0,1,0,0,1,1,1],M=[e,y,s+1,e+1,y,s+1,e,y,s,e+1,y,s],T=c.length;n.push(...M),a.push(0,1,0,0,1,0,0,1,0,0,1,0),h.push(...w);for(let t=0;t<4;t++)l.push(r,r,r),d.push(g?1:0),u.push(0),f.push(1);c.push(p.value,p.value+2,p.value+1,p.value+1,p.value+2,p.value+3),m.push({materialIndex:x,start:T,count:6}),p.value+=4}const T=[e,i,s,e+1,i,s+1,e,i+1,s,e+1,i+1,s+1],E=[e+1,i,s,e,i,s+1,e+1,i+1,s,e,i+1,s+1],A=[0,0,1,0,0,1,1,1],S=BlockColorSystem.getBlockFaceLighting(t,e,i,s,2,6),_=S.finalBrightness,R=S.isSunlit;for(const t of[T,E]){const e=c.length;n.push(...t),a.push(0,0,0,0,0,0,0,0,0,0,0,0),h.push(...A);for(let t=0;t<4;t++)l.push(_,_,_),d.push(R?1:0),u.push(0),f.push(0);c.push(p.value,p.value+2,p.value+1),c.push(p.value+1,p.value+2,p.value+3),m.push({materialIndex:w,start:e,count:6}),p.value+=4}const k=[{face:5,ofs:-.001,quad:(t,e,i,s)=>[t+s,e,i,t+s,e,i+1,t+s,e+1,i,t+s,e+1,i+1]},{face:4,ofs:1.001,quad:(t,e,i,s)=>[t+s,e,i+1,t+s,e,i,t+s,e+1,i+1,t+s,e+1,i]},{face:2,ofs:-.001,quad:(t,e,i,s)=>[t,e,i+s,t+1,e,i+s,t,e+1,i+s,t+1,e+1,i+s]},{face:3,ofs:1.001,quad:(t,e,i,s)=>[t+1,e,i+s,t,e,i+s,t+1,e+1,i+s,t,e+1,i+s]}];for(const o of k){let g=e,y=i,w=s;5===o.face&&(g=e-1),4===o.face&&(g=e+1),2===o.face&&(w=s-1),3===o.face&&(w=s+1);const b=t.getTile(g,y,w);if(b&&0!==b){const M=Tiles.byId[b],x=M?M.getTextureKey(o.face):null,T=x?r[x]:void 0;if(void 0!==T){const r=c.length,M=o.quad(e,i,s,o.ofs);n.push(...M),a.push(0,0,0,0,0,0,0,0,0,0,0,0),h.push(...A);const x=BlockColorSystem.getBlockFaceLighting(t,g,y,w,o.face,b).finalBrightness,E=BlockColorSystem.getBlockFaceLighting(t,g,y,w,o.face,b).isSunlit;for(let t=0;t<4;t++)l.push(x,x,x),d.push(E?1:0),u.push(1),f.push(0);c.push(p.value,p.value+2,p.value+1),c.push(p.value+1,p.value+2,p.value+3),m.push({materialIndex:T,start:r,count:6}),p.value+=4}}}}export class Particle{constructor(t,e,i,s,o,r,n,a){this.scene=t,this.removed=!1,this.x=i,this.y=s,this.z=o,this.xo=i,this.yo=s,this.zo=o;const h=Math.acos(2*Math.random()-1),l=2*Math.PI*Math.random(),c=Math.sin(h)*Math.cos(l),d=Math.cos(h),u=Math.sin(h)*Math.sin(l),f=.45*(.9+.2*Math.random())/3;this.xd=r+c*f,this.yd=n+d*f*.8,this.zd=a+u*f,this.size=.2*(.5*Math.random()+.5),this.birth=performance.now(),this.lifetimeMs=3e3+Math.floor(500*Math.random()),this.grounded=!1,this.groundContactStart=0;const m=new THREE.SpriteMaterial({map:e,color:16777215,transparent:!0,alphaTest:.01});try{const t=e&&e.image;if(t&&"undefined"!=typeof document){const e=Math.max(1,t.width||4),i=Math.max(1,t.height||4),s=document.createElement("canvas");s.width=e,s.height=i;const o=s.getContext("2d");o.imageSmoothingEnabled=!1,o.drawImage(t,0,0,e,i);const r=Math.max(0,Math.floor(.4*e)),n=Math.max(0,Math.floor(.4*i)),a=Math.max(1,Math.min(4,e-r)),h=Math.max(1,Math.min(4,i-n)),l=o.getImageData(r,n,a,h).data;let c=0,d=0,u=0,f=0;for(let t=0;t<l.length;t+=4)l[t+3]<8||(c+=l[t],d+=l[t+1],u+=l[t+2],f++);f>0&&(c=Math.round(c/f),d=Math.round(d/f),u=Math.round(u/f),m.color=new THREE.Color(c/255,d/255,u/255))}}catch(t){}this.sprite=new THREE.Sprite(m),this.sprite.material.toneMapped=!1,this.sprite.scale.set(this.size,this.size,this.size),this.sprite.position.set(this.x,this.y,this.z),this.scene.add(this.sprite)}tick(t){this.xo=this.x,this.yo=this.y,this.zo=this.z;const e=performance.now();if(e-this.birth>=this.lifetimeMs)return void this.remove();this.yd-=.06;let i=this.x+this.xd,s=this.y+this.yd,o=this.z+this.zd;const r=Math.floor(i),n=Math.floor(s),a=Math.floor(o),h=(e,i,s)=>!(!t||e<0||i<0||s<0||e>=t.width||s>=t.height||i>=t.depth)&&0!==t.getTile(e,i,s);if(h(r,Math.floor(this.y),a)&&(i=this.x,o=this.z,this.xd*=-.3,this.zd*=-.3),h(r,n,a)&&(s=Math.ceil(s)+.001,this.yd=0,this.xd*=.4,this.zd*=.4,this.grounded||(this.grounded=!0,this.groundContactStart=performance.now())),this.x=i,this.y=s,this.z=o,this.xd*=.96,this.yd*=.995,this.zd*=.96,this.sprite){this.sprite.position.set(this.x,this.y,this.z);const t=(e-this.birth)/this.lifetimeMs;this.sprite.material.opacity=1-t}this.grounded&&e-(this.groundContactStart||0)>=500&&this.remove()}remove(){this.removed||(this.removed=!0,this.sprite&&this.scene&&this.scene.remove(this.sprite))}}export const PARTICLES_USE_WORLD_LIGHTING=!1;export const PARTICLES_LIFETIME_MS=1e3;export const PARTICLES_DERENDER_AFTER_MS=2500;export const PARTICLE_CONTRAST_MULTIPLIER=.75;export const PARTICLE_FLIP_GRASS_TEXTURES=!0;export const DEFAULT_PARTICLE_SIZE_MULT=2.25;export const PARTICLE_INVERT_COLOR=!1;export const PARTICLE_TEXTURE_ROTATION=Math.PI;export const PARTICLE_SATURATION_MULTIPLIER=1;export const PARTICLE_APPLY_PNG_COLOR=!0;export const PARTICLE_PNG_COLOR_INTENSITY=1;export const PARTICLE_VELOCITY_DAMP=.92;export const PARTICLE_GROUND_DAMP=.9;export async function generateWorldInline(t,e,i){const s=new Uint8Array(t*e*i),o=new Uint8Array(t*e),r=(e,s,o)=>e+(i-1-s)*t+o*t*i,n=Tiles&&Tiles.stone&&Tiles.stone.id?Tiles.stone.id:1,a=Tiles&&Tiles.dirt&&Tiles.dirt.id?Tiles.dirt.id:2,h=Tiles&&Tiles.grass&&Tiles.grass.id?Tiles.grass.id:9,l=Tiles&&Tiles.bedrock&&Tiles.bedrock.id?Tiles.bedrock.id:8;function c(t,e){const i=43758.5453*Math.sin(12.9898*t+78.233*e);return i-Math.floor(i)}for(let d=0;d<e;d++)for(let e=0;e<t;e++){const u=.6*c(e/32,d/32)+.35*c(e/8,d/8)+.05*c(e/4,d/4),f=Math.max(2,Math.min(i-1,Math.floor(.45*i+u*(.18*i))));for(let t=0;t<i;t++){const i=0===t?l:t<f-3?n:t<f?a:0;0!==i&&(s[r(e,t,d)]=i)}s[r(e,f,d)]=h,o[e+d*t]=f}return{blocks:s,lightDepths:o}}const{BufferAttribute:BufferAttribute,BufferGeometry:BufferGeometry,Float32BufferAttribute:Float32BufferAttribute,InstancedBufferAttribute:InstancedBufferAttribute,InterleavedBuffer:InterleavedBuffer,InterleavedBufferAttribute:InterleavedBufferAttribute,TriangleFanDrawMode:TriangleFanDrawMode,TriangleStripDrawMode:TriangleStripDrawMode,TrianglesDrawMode:TrianglesDrawMode,Vector3:Vector3}=THREE;export function computeMikkTSpaceTangents(t,e,i=!0){if(!e||!e.isReady)throw new Error("BufferGeometryUtils: Initialized MikkTSpace library required.");if(!t.hasAttribute("position")||!t.hasAttribute("normal")||!t.hasAttribute("uv"))throw new Error('BufferGeometryUtils: Tangents require "position", "normal", and "uv" attributes.');function s(t){if(t.normalized||t.isInterleavedBufferAttribute){const e=new Float32Array(t.count*t.itemSize);for(let i=0,s=0;i<t.count;i++)e[s++]=t.getX(i),e[s++]=t.getY(i),t.itemSize>2&&(e[s++]=t.getZ(i));return e}return t.array instanceof Float32Array?t.array:new Float32Array(t.array)}const o=t.index?t.toNonIndexed():t,r=e.generateTangents(s(o.attributes.position),s(o.attributes.normal),s(o.attributes.uv));if(i)for(let t=3;t<r.length;t+=4)r[t]*=-1;return o.setAttribute("tangent",new BufferAttribute(r,4)),t!==o&&t.copy(o),t}function mergeAttributes(t){let e,i,s,o=-1,r=0;for(let n=0;n<t.length;n++){const a=t[n];if(a.isInterleavedBufferAttribute)return console.error("THREE.BufferGeometryUtils: .mergeAttributes() failed. InterleavedBufferAttributes are not supported."),null;if(void 0===e)e=a.array.constructor;else if(e!==a.array.constructor)return console.error("THREE.BufferGeometryUtils: .mergeAttributes() failed. BufferAttribute.array must be of consistent array types across matching attributes."),null;if(void 0===i)i=a.itemSize;else if(i!==a.itemSize)return console.error("THREE.BufferGeometryUtils: .mergeAttributes() failed. BufferAttribute.itemSize must be consistent across matching attributes."),null;if(void 0===s)s=a.normalized;else if(s!==a.normalized)return console.error("THREE.BufferGeometryUtils: .mergeAttributes() failed. BufferAttribute.normalized must be consistent across matching attributes."),null;if(-1===o)o=a.gpuType;else if(o!==a.gpuType)return console.error("THREE.BufferGeometryUtils: .mergeAttributes() failed. BufferAttribute.gpuType must be consistent across matching attributes."),null;r+=a.array.length}const n=new e(r);let a=0;for(let e=0;e<t.length;e++)n.set(t[e].array,a),a+=t[e].array.length;const h=new BufferAttribute(n,i,s);return-1!==o&&(h.gpuType=o),h}export function deepCloneAttribute(t){return t.isInstancedInterleavedBufferAttribute||t.isInterleavedBufferAttribute?deinterleaveAttribute(t):t.isInstancedBufferAttribute?(new InstancedBufferAttribute).copy(t):(new BufferAttribute).copy(t)}export function interleaveAttributes(t){let e,i=0,s=0;for(let o=0;o<t.length;o++){const r=t[o];if(void 0===e)e=r.array.constructor;else if(e!==r.array.constructor)return console.error("AttributeBuffers of different types cannot be interleaved"),null;i+=r.array.length,s+=r.itemSize}const o=new InterleavedBuffer(new e(i),s);let r=0;const n=[],a=["getX","getY","getZ","getW"],h=["setX","setY","setZ","setW"];for(let e=0;e<t.length;e++){const i=t[e],s=i.itemSize,l=i.count,c=new InterleavedBufferAttribute(o,s,r,i.normalized);n.push(c),r+=s;for(let t=0;t<l;t++)for(let e=0;e<s;e++)c[h[e]](t,i[a[e]](t))}return n}export function deinterleaveAttribute(t){const e=t.data.array.constructor,i=t.count,s=t.itemSize,o=t.normalized,r=new e(i*s),n=t.isInstancedInterleavedBufferAttribute?new InstancedBufferAttribute(r,s,o,t.meshPerAttribute):new BufferAttribute(r,s,o);for(let e=0;e<i;e++)n.setX(e,t.getX(e)),s>=2&&n.setY(e,t.getY(e)),s>=3&&n.setZ(e,t.getZ(e)),s>=4&&n.setW(e,t.getW(e));return n}export function deinterleaveGeometry(t){const e=t.attributes,i=t.morphTargets,s=new Map;for(const t in e){const i=e[t];i.isInterleavedBufferAttribute&&(s.has(i)||s.set(i,deinterleaveAttribute(i)),e[t]=s.get(i))}for(const t in i){const e=i[t];e.isInterleavedBufferAttribute&&(s.has(e)||s.set(e,deinterleaveAttribute(e)),i[t]=s.get(e))}}export function mergeGeometries(t,e=!1){const i=null!==t[0].index,s=new Set(Object.keys(t[0].attributes)),o=new Set(Object.keys(t[0].morphAttributes)),r={},n={},a=t[0].morphTargetsRelative,h=new BufferGeometry;let l=0;for(let c=0;c<t.length;c++){const d=t[c];let u=0;if(i!==(null!==d.index))return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+c+". All geometries must be compatible."),null;for(const t in d.attributes){if(!s.has(t))return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+c+". All geometries must share attributes."),null;void 0===r[t]&&(r[t]=[]),r[t].push(d.attributes[t]),u++}if(u!==s.size)return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+c+". Make sure all geometries have the same number of attributes."),null;if(a!==d.morphTargetsRelative)return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+c+". .morphTargetsRelative must be consistent."),null;for(const t in d.morphAttributes){if(!o.has(t))return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+c+".  .morphAttributes must be consistent."),null;void 0===n[t]&&(n[t]=[]),n[t].push(d.morphAttributes[t])}if(e){let t;if(i)t=d.index.count;else{if(void 0===d.attributes.position)return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+c+". The geometry must have either an index or a position attribute"),null;t=d.attributes.position.count}h.addGroup(l,t,c),l+=t}}if(i){let e=0;const i=[];for(let s=0;s<t.length;s++){const o=t[s].index;for(let t=0;t<o.count;t++)i.push(o.getX(t)+e);e+=t[s].attributes.position.count}h.setIndex(i)}for(const t in r){const e=mergeAttributes(r[t]);if(!e)return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed while trying to merge the "+t+" attribute."),null;h.setAttribute(t,e)}for(const t in n){const e=n[t][0].length;if(0===e)break;h.morphAttributes=h.morphAttributes||{},h.morphAttributes[t]=[];for(let i=0;i<e;i++){const e=[];for(let s=0;s<n[t].length;s++)e.push(n[t][s][i]);const s=mergeAttributes(e);if(!s)return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed while trying to merge the "+t+" morphAttribute."),null;h.morphAttributes[t].push(s)}}return h}export function estimateBytesUsed(t){let e=0;for(const i in t.attributes){const s=t.getAttribute(i);e+=s.count*s.itemSize*s.array.BYTES_PER_ELEMENT}const i=t.getIndex();return e+=i?i.count*i.itemSize*i.array.BYTES_PER_ELEMENT:0,e}export function mergeVertices(t,e=1e-4){e=Math.max(e,Number.EPSILON);const i={},s=t.getIndex(),o=t.getAttribute("position"),r=s?s.count:o.count;let n=0;const a=Object.keys(t.attributes),h={},l={},c=[],d=["getX","getY","getZ","getW"],u=["setX","setY","setZ","setW"];for(let e=0;e<a.length;e++){const i=a[e],s=t.attributes[i];h[i]=new BufferAttribute(new s.array.constructor(s.count*s.itemSize),s.itemSize,s.normalized);const o=t.morphAttributes[i];o&&(l[i]=new BufferAttribute(new o.array.constructor(o.count*o.itemSize),o.itemSize,o.normalized))}const f=.5*e,m=Math.log10(1/e),p=Math.pow(10,m),g=f*p;for(let e=0;e<r;e++){const o=s?s.getX(e):e;let r="";for(let e=0;e<a.length;e++){const i=a[e],s=t.getAttribute(i),n=s.itemSize;for(let t=0;t<n;t++)r+=~~(s[d[t]](o)*p+g)+","}if(r in i)c.push(i[r]);else{for(let e=0;e<a.length;e++){const i=a[e],s=t.getAttribute(i),r=t.morphAttributes[i],c=s.itemSize,f=h[i],m=l[i];for(let t=0;t<c;t++){const e=d[t],i=u[t];if(f[i](n,s[e](o)),r)for(let t=0;t<r.length;t++)m[t][i](n,r[t][e](o))}}i[r]=n,c.push(n),n++}}const y=t.clone();for(const e in t.attributes){const t=h[e];if(y.setAttribute(e,new BufferAttribute(t.array.slice(0,n*t.itemSize),t.itemSize,t.normalized)),e in l)for(let t=0;t<l[e].length;t++){const i=l[e][t];y.morphAttributes[e][t]=new BufferAttribute(i.array.slice(0,n*i.itemSize),i.itemSize,i.normalized)}}return y.setIndex(c),y}export function toTrianglesDrawMode(t,e){if(e===TrianglesDrawMode)return console.warn("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Geometry already defined as triangles."),t;if(e===TriangleFanDrawMode||e===TriangleStripDrawMode){let i=t.getIndex();if(null===i){const e=[],s=t.getAttribute("position");if(void 0===s)return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Undefined position attribute."),t;for(let t=0;t<s.count;t++)e.push(t);t.setIndex(e),i=t.getIndex()}const s=i.count-2,o=[];if(e===TriangleFanDrawMode)for(let t=1;t<=s;t++)o.push(i.getX(0)),o.push(i.getX(t)),o.push(i.getX(t+1));else for(let t=0;t<s;t++)t%2==0?(o.push(i.getX(t)),o.push(i.getX(t+1)),o.push(i.getX(t+2))):(o.push(i.getX(t+2)),o.push(i.getX(t+1)),o.push(i.getX(t)));o.length/3!==s&&console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");const r=t.clone();return r.setIndex(o),r.clearGroups(),r}return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unknown draw mode:",e),t}export function computeMorphedAttributes(t){const e=new Vector3,i=new Vector3,s=new Vector3,o=new Vector3,r=new Vector3,n=new Vector3,a=new Vector3,h=new Vector3,l=new Vector3;function c(c,d,u,f,m,p,g,y,w){e.fromBufferAttribute(d,m),i.fromBufferAttribute(d,p),s.fromBufferAttribute(d,g);const b=c.morphTargetInfluences;if(u&&b){a.set(0,0,0),h.set(0,0,0),l.set(0,0,0);for(let t=0;t<u.length;t++){const c=b[t],d=u[t];0!==c&&(o.fromBufferAttribute(d,m),r.fromBufferAttribute(d,p),n.fromBufferAttribute(d,g),f?(a.addScaledVector(o,c),h.addScaledVector(r,c),l.addScaledVector(n,c)):(a.addScaledVector(o.sub(e),c),h.addScaledVector(r.sub(i),c),l.addScaledVector(n.sub(s),c)))}e.add(a),i.add(h),s.add(l)}t.isSkinnedMesh&&(t.applyBoneTransform(m,e),t.applyBoneTransform(p,i),t.applyBoneTransform(g,s)),y[3*m+0]=e.x,y[3*m+1]=e.y,y[3*m+2]=e.z,y[3*p+0]=i.x,y[3*p+1]=i.y,y[3*p+2]=i.z,y[3*g+0]=s.x,y[3*g+1]=s.y,y[3*g+2]=s.z}const d=t.geometry,u=t.material,f=d.index,m=d.attributes.position,p=d.morphAttributes.position,g=d.morphTargetsRelative,y=d.attributes.normal,w=(d.morphAttributes.position,d.groups),b=d.drawRange,M=new Float32Array(m.count*m.itemSize),x=new Float32Array(y.count*y.itemSize);let T,E,A,S,_;if(null!==f)if(Array.isArray(u))for(let e=0;e<w.length;e++){const i=w[e];S=Math.max(i.start,b.start),_=Math.min(i.start+i.count,b.start+b.count);for(let e=S;e<_;e+=3)T=f.getX(e),E=f.getX(e+1),A=f.getX(e+2),c(t,m,p,g,T,E,A,M)}else{S=Math.max(0,b.start),_=Math.min(f.count,b.start+b.count);for(let e=S;e<_;e+=3)T=f.getX(e),E=f.getX(e+1),A=f.getX(e+2),c(t,m,p,g,T,E,A,M)}else if(Array.isArray(u))for(let e=0;e<w.length;e++){const i=w[e];S=Math.max(i.start,b.start),_=Math.min(i.start+i.count,b.start+b.count);for(let e=S;e<_;e+=3)T=e,E=e+1,A=e+2,c(t,m,p,g,T,E,A,M)}else{S=Math.max(0,b.start),_=Math.min(m.count,b.start+b.count);for(let e=S;e<_;e+=3)T=e,E=e+1,A=e+2,c(t,m,p,g,T,E,A,M)}return{positionAttribute:m,normalAttribute:y,morphedPositionAttribute:new Float32BufferAttribute(M,3),morphedNormalAttribute:new Float32BufferAttribute(x,3)}}export function mergeGroups(t){if(0===t.groups.length)return console.warn("THREE.BufferGeometryUtils.mergeGroups(): No groups are defined. Nothing to merge."),t;let e=t.groups.sort(((t,e)=>t.materialIndex!==e.materialIndex?t.materialIndex-e.materialIndex:t.start-e.start));if(null===t.getIndex()){const e=t.getAttribute("position"),i=[];if(void 0===e)return console.error("THREE.BufferGeometryUtils.mergeGroups(): Undefined position attribute. Processing not possible."),t;for(let t=0;t<e.count;t+=3)i.push(t,t+1,t+2);t.setIndex(i)}const i=t.getIndex(),s=[];for(let t=0;t<e.length;t++){const o=e[t],r=o.start,n=r+o.count;for(let t=r;t<n;t++)s.push(i.getX(t))}t.dispose(),t.setIndex(s);let o=0;for(let t=0;t<e.length;t++){const i=e[t];i.start=o,o+=i.count}let r=e[0];t.groups=[r];for(let i=1;i<e.length;i++){const s=e[i];r.materialIndex===s.materialIndex?r.count+=s.count:(r=s,t.groups.push(r))}return t}export function toCreasedNormals(t,e=Math.PI/3){const i=Math.cos(e),s=100*(1+1e-10),o=[new Vector3,new Vector3,new Vector3],r=new Vector3,n=new Vector3,a=new Vector3;function h(t){return`${~~(t.x*s)},${~~(t.y*s)},${~~(t.z*s)}`}const l=t.index?t.toNonIndexed():t,c=l.attributes.position,d={};for(let t=0;t<c.count/3;t++){const e=3*t,i=o[0].fromBufferAttribute(c,e+0),s=o[1].fromBufferAttribute(c,e+1),a=o[2].fromBufferAttribute(c,e+2);r.subVectors(a,s),n.subVectors(i,s);const l=(new Vector3).crossVectors(r,n).normalize();for(let t=0;t<3;t++){const e=h(o[t]);e in d||(d[e]=[]),d[e].push(l)}}const u=new Float32Array(3*c.count),f=new BufferAttribute(u,3,!1);for(let t=0;t<c.count/3;t++){const e=3*t,s=o[0].fromBufferAttribute(c,e+0),l=o[1].fromBufferAttribute(c,e+1),u=o[2].fromBufferAttribute(c,e+2);r.subVectors(u,l),n.subVectors(s,l),a.crossVectors(r,n).normalize();for(let t=0;t<3;t++){const s=d[h(o[t])],r=new Vector3(0,0,0);for(let t=0;t<s.length;t++){const e=s[t];a.dot(e)>i&&r.add(e)}r.normalize(),f.setXYZ(e+t,r.x,r.y,r.z)}}return l.setAttribute("normal",f),l}export function mergeBufferGeometries(t,e=!1){return console.warn("THREE.BufferGeometryUtils: mergeBufferGeometries() has been renamed to mergeGeometries()."),mergeGeometries(t,e)}export function mergeBufferAttributes(t){return console.warn("THREE.BufferGeometryUtils: mergeBufferAttributes() has been renamed to mergeAttributes()."),mergeAttributes(t)}export class ClassicParticle{static MIN_BRIGHTNESS=.35;static BASE_OPACITY=.95;gravity=1;baseSizeMul=1;lifetimeScale=1;static DEFAULT_FRAGMENT_SCALE=2.5;static FRAGMENT_SAMPLE_FRACTION=.35;static FRAGMENT_SIZE_MULT=1.6;constructor(t,e,i,s,o,r,n=0,a=0,h=0){this.scene=t,this.level=e,this.removed=!1,this.onGround=!1,this.x=s,this.y=o,this.z=r,this.xo=s,this.yo=o,this.zo=r,this.rCol=1,this.gCol=1,this.bCol=1,this.xd=n+.25*(2*Math.random()-1),this.yd=a+.25*(2*Math.random()-1),this.zd=h+.25*(2*Math.random()-1);const l=.15*(Math.random()+Math.random()+1);let c;this.size=2.25*l,this.birth=performance.now(),this.lifetime=Math.floor(1e3*(this.lifetimeScale||1)),this.derenderAfterMs=2500;try{const e=i&&i.image?ClassicParticle._makeFragmentTextureFrom(i,ClassicParticle.FRAGMENT_SAMPLE_FRACTION):i;try{const t=e&&e.image&&e.image.src?String(e.image.src):i&&i.image&&i.image.src?String(i.image.src):"";/grass/i.test(t)&&e&&"flipY"in e&&(e.flipY=!e.flipY)}catch(t){}try{const t=e&&e.image?e.image:i&&i.image?i.image:null;if(t&&t.width&&t.height){const e=Math.max(4,Math.floor(.25*t.width)),i=Math.max(4,Math.floor(.25*t.height)),s=document.createElement("canvas");s.width=e,s.height=i;const o=s.getContext("2d",{willReadFrequently:!0});o.imageSmoothingEnabled=!1,o.drawImage(t,0,0,t.width,t.height,0,0,e,i);const r=o.getImageData(0,0,e,i).data;let n=0,a=0,h=0,l=0;for(let t=0;t<r.length;t+=4)r[t+3]>8&&(n+=r[t],a+=r[t+1],h+=r[t+2],l++);if(l>0){const t=n/l/255,e=a/l/255,i=h/l/255,s=Math.max(0,Math.min(1,1));this.rCol=1*(1-s)+t*s,this.gCol=1*(1-s)+e*s,this.bCol=1*(1-s)+i*s}}}catch(t){this.rCol=1,this.gCol=1,this.bCol=1}c=new THREE.SpriteMaterial({map:e||i,transparent:!0,alphaTest:.01,color:16777215})}catch(t){c=new THREE.SpriteMaterial({map:i,transparent:!0,alphaTest:.01,color:16777215})}try{c&&(c.center&&"function"==typeof c.center.set?c.center.set(.5,.5):c.center=new THREE.Vector2(.5,.5),c.rotation,c.rotation=PARTICLE_TEXTURE_ROTATION)}catch(t){}c.toneMapped=!1,c.opacity=ClassicParticle.BASE_OPACITY,c.depthTest=!0,this.sprite=new THREE.Sprite(c),this.baseSizeMul=this.baseSizeMul*ClassicParticle.DEFAULT_FRAGMENT_SCALE*ClassicParticle.FRAGMENT_SIZE_MULT,this._updateSpriteScale(),this.sprite.position.set(this.x,this.y,this.z),this.scene.add(this.sprite)}setPower(t){return this.xd*=t,this.yd=(this.yd-.1)*t+.1,this.zd*=t,this}scale(t){return this.size*=t,this.baseSizeMul*=t,this._updateSpriteScale(),this}static _makeFragmentTextureFrom(t,e=.35){try{const i=t.image;if(!i||!i.width||!i.height)return t;const s=Math.max(4,Math.floor(i.width*Math.min(1,Math.max(.05,e)))),o=Math.max(4,Math.floor(i.height*Math.min(1,Math.max(.05,e)))),r=Math.floor(Math.random()*Math.max(1,i.width-s)),n=Math.floor(Math.random()*Math.max(1,i.height-o)),a=document.createElement("canvas");a.width=s,a.height=o;const h=a.getContext("2d");h.imageSmoothingEnabled=!1,h.drawImage(i,r,n,s,o,0,0,s,o);const l=new THREE.CanvasTexture(a);return l.magFilter=THREE.NearestFilter,l.minFilter=THREE.NearestFilter,l.flipY=!1,l}catch(e){return t}}_updateSpriteScale(){const t=.1*this.size*this.baseSizeMul;this.sprite&&this.sprite.scale.set(t,t,t)}tick(t){this.xo=this.x,this.yo=this.y,this.zo=this.z;{const t=performance.now(),e=t-(this.birth||t);if(e>=this.lifetime)return void this.remove();if(e>=this.derenderAfterMs&&!this.removed){try{this.remove()}catch(o){}return}}this.yd-=.04*this.gravity;let e=this.x+this.xd,i=this.y+this.yd,s=this.z+this.zd;const o=(e,i,s)=>t&&e>=0&&i>=0&&s>=0&&e<t.width&&s<t.height&&i<t.depth&&0!==t.getTile(e,i,s);if(o(Math.floor(e),Math.floor(this.y),Math.floor(s))&&(e=this.x,s=this.z,this.xd*=-.3,this.zd*=-.3),o(Math.floor(e),Math.floor(i),Math.floor(s))?(i=Math.ceil(i)+.001,this.onGround=!0,this.yd=0,this.xd*=.98,this.zd*=.98):this.onGround=!1,this.x=e,this.y=i,this.z=s,this.xd*=.98,this.yd*=.98,this.zd*=.98,this.sprite){this.sprite.position.set(this.x,this.y,this.z);try{let t=this.rCol,e=this.gCol,i=this.bCol;const s=new THREE.Color(t,e,i);s.multiplyScalar(.75),this.sprite.material.color.copy(s)}catch(t){}}}remove(){if(!this.removed){this.removed=!0;try{this.scene&&this.sprite&&(this.scene.remove(this.sprite),this.sprite.material.map&&this.sprite.material.map.dispose&&this.sprite.material.map.dispose())}catch(t){}finally{this.sprite=null}}}}export class ParticleEngine{constructor(t,e,i){this.scene=t,this.level=e,this.texture=i,this.particles=[],this.MAX_PARTICLES=60}add(t,e,i,s=0,o=0,r=0,n=null){if(this.particles.length>=this.MAX_PARTICLES){const e=this.particles.shift();try{e&&"function"==typeof e.remove&&e.remove()}catch(t){}}const a=new ClassicParticle(this.scene,this.level,n||this.texture,t,e,i,s,o,r);this.particles.push(a)}burst(t,e,i,s=8,o=.35,r=null){const n=Math.max(0,this.MAX_PARTICLES-this.particles.length),a=Math.min(s,Math.max(1,n));for(let s=0;s<a;s++){const s=(2*Math.random()-1)*o,n=(2*Math.random()-1)*o,a=(2*Math.random()-1)*o;this.add(t+.3*(Math.random()-.5),e+.3*(Math.random()-.5),i+.3*(Math.random()-.5),s,n+.1,a,r)}}tick(){for(let t=this.particles.length-1;t>=0;t--){const e=this.particles[t];e.tick(this.level),e.removed&&this.particles.splice(t,1)}}}const GRASS_SOUNDS=["wet_grass1.ogg","wet_grass2.ogg","wet_grass3.ogg","wet_grass4.ogg"],STONE_SOUNDS=["stone1.ogg","stone2.ogg","stone3.ogg","stone4.ogg"];let audioEnabled=!0,masterVolume=.9;const audioPools={grass:[],stone:[]},MAX_CONCURRENT_VOICES=4,activeCounts={grass:0,stone:0},recentPlays=new Map;function markPlayed(t){recentPlays.set(t,performance.now())}function wasRecentlyPlayed(t,e=120){const i=recentPlays.get(t);return!(!i||performance.now()-i>e&&(recentPlays.delete(t),1))}try{createAudioPool(GRASS_SOUNDS,audioPools.grass),createAudioPool(STONE_SOUNDS,audioPools.stone)}catch(t){console.warn("[Sound] pool init failed",t)}function playPooled(t){if(!audioEnabled)return;const e=audioPools[t];if(!e||0===e.length)return;if(activeCounts[t]>=MAX_CONCURRENT_VOICES)return;const i=e[Math.floor(Math.random()*e.length)];if(i)try{const e=i.dataset.name,s=e&&window["zip_audio_"+e],o=i.cloneNode(!0);o.src=s||o.src||"",o.volume=Math.max(0,Math.min(1,masterVolume*("grass"===t?.85:1)));try{o.playbackRate=.96+.08*Math.random()}catch(t){}activeCounts[t]+=1;const r=()=>{try{activeCounts[t]=Math.max(0,activeCounts[t]-1)}catch(t){}};o.addEventListener("ended",r,{once:!0}),o.addEventListener("error",r,{once:!0}),setTimeout((()=>{try{o.play().catch((()=>{}))}catch(t){}}),0)}catch(t){}}function createAudioPool(t,e){for(const i of t){const t=document.createElement("audio");t.preload="auto",t.dataset.name=i;const s=window["zip_audio_"+i];s&&(t.src=s),t.load(),e.push(t)}}export function playBreakSoundForTile(t,e=null){try{if(!audioEnabled)return;let i=t,s=null;if(t&&"object"==typeof t)if("id"in t&&(i=t.id),t.key)s=String(t.key).toLowerCase();else if("function"==typeof t.getTextureKey)try{s=String(t.getTextureKey(0)||"").toLowerCase()}catch(t){}const o=e||`tile_${i}_${s||""}`;if(wasRecentlyPlayed(o,140))return;markPlayed(o);const r=s&&(s.includes("grass")||s.includes("dirt")||s.includes("turf"))||2===i||3===i||9===i,n=s&&s.includes("stone")||1===i,a=.5;if("undefined"!=typeof window&&"function"==typeof window.playPooled){const t=t=>{try{window.playPooled(t,a)}catch{try{window.playPooled(t,{volume:a})}catch{try{window.playPooled(t)}catch(t){}}}};r?t("grass"):n&&t("stone")}else r?playPooled("grass"):n&&playPooled("stone")}catch(t){}}export const config={player:{walkSpeed:.88,jumpSpeed:.075,gravityPerTick:.002,mouseSensitivity:{x:.15,y:.15},maxJumpHeightBlocks:1.8,jumpHeightCapBlocks:1.8},camera:{thirdPersonDistance:4,heightOffset:.35,maxFirstPitch:90,maxThirdPitch:85},zombie:{baseSpeed:.036*.825,walkSpeedFactor:.1*1.5,gravity:.045,jumpPower:.075,idleJumpImpulse:.084,jumpCooldownMs:1e3},pathfinding:{maxSteps:24},controls:{spawnKey:"KeyG",togglePathsKey:"Digit7"},removeLiquidSystem:!0,removeMinecraftExtras:!0,blockPreview:{top:"-17px",bottom:"2px",right:"-16px",width:"92px",height:void 0,zIndex:2e3,pointerEvents:"none"}};export class Font{constructor(t="/default.gif"){this.charWidths=new Uint8Array(256),this.image=new Image,this.ready=!1,this.letterSpacingMultiplier=.5,this.spacingMultiplier=1.5,this.periodSpacingMultiplier=.64,this.doubleOneSpacingMultiplier=1.3,this.periodGroupOffsetPx=2,this.image.onload=()=>{try{this._processImage()}finally{this.ready=!0}},this.image.onerror=()=>{console.warn("Font image failed to load:",t),this.ready=!0},this.image.src=t}_processImage(){const t=this.image,e=t.width,i=t.height,s=document.createElement("canvas");s.width=e,s.height=i;const o=s.getContext("2d",{willReadFrequently:!0});o.imageSmoothingEnabled=!1,o.drawImage(t,0,0,e,i);const r=o.getImageData(0,0,e,i).data,n=Math.floor(e/16)||8,a=Math.floor(i/16)||8;for(let t=0;t<128;t++){const i=t%16,s=Math.floor(t/16);let o,h;for(o=0;o<n;o++){h=!0;const t=i*n+o;for(let i=0;i<a&&h;i++)r[4*((s*a+i)*e+t)+3]>128&&(h=!1);if(!h)break}32===t&&(o=Math.floor(n/2)),this.charWidths[t]=o}}drawShadow(t,e,i,s,o="#ffffff"){t&&this.ready&&(this.draw(t,e,i+1,s+1,"rgba(63,63,63,1)",!0),this.draw(t,e,i,s,o,!1))}draw(t,e,i,s,o="#ffffff",r=!1){if(!t||!this.ready)return;if(!this.image||!this.image.width)return;t.imageSmoothingEnabled=!1;let n=0;const a=r?.92:1,h=Math.floor(this.image.width/16)||8,l=Math.floor(this.image.height/16)||8;t.save(),t.globalAlpha=a;const c=document.createElement("canvas");c.width=h,c.height=l;const d=c.getContext("2d");d.imageSmoothingEnabled=!1;for(let r=0;r<e.length;r++){const a=e.charCodeAt(r);if(38===a&&r+1<e.length){r++;continue}const u=a%16*h,f=Math.floor(a/16)*l;try{d.clearRect(0,0,h,l),d.drawImage(this.image,u,f,h,l,0,0,h,l),o&&(d.globalCompositeOperation="source-in",d.fillStyle=o,d.fillRect(0,0,h,l),d.globalCompositeOperation="source-over"),t.drawImage(c,0,0,h,l,i+n+("."===String.fromCharCode(a)&&this.periodGroupOffsetPx||0),s,h,l)}catch(t){}const m=this.charWidths[a]||h;this.letterSpacingMultiplier=this.letterSpacingMultiplier??.5;const p=m*(this.letterSpacingMultiplier||1),g=r>0?e.charAt(r-1):"",y=r+1<e.length?e.charAt(r+1):"",w="."===String.fromCharCode(a)||"."===g||"."===y?this.periodSpacingMultiplier??.5:1;this.tAfterSpacingMultiplier=this.tAfterSpacingMultiplier??1.6;const b="t"===g||"T"===g?this.tAfterSpacingMultiplier??1:1;this.eAndsSpacingMultiplier=this.eAndsSpacingMultiplier??.7;const M=g&&("e"===g.toLowerCase()||"s"===g.toLowerCase()),x=y&&("e"===y.toLowerCase()||"s"===y.toLowerCase()),T="e"===String.fromCharCode(a).toLowerCase()||"s"===String.fromCharCode(a).toLowerCase(),E=M||x||T?this.eAndsSpacingMultiplier??1:1;let A=1;if("number"==typeof this.doubleOneSpacingMultiplier&&"0.0.9a"===e){const t=String.fromCharCode(a),i=r+1<e.length?e.charAt(r+1):"";"1"===t&&"1"===i&&(A=this.doubleOneSpacingMultiplier)}const S="0.0.9a"===e,_="."===String.fromCharCode(a);S&&_&&this.periodGroupOffsetPx,n+=Math.round(p*(this.spacingMultiplier||1)*w*b*A*E)}t.restore()}width(t){if(!t)return 0;let e=0;for(let i=0;i<t.length;i++){const s=t.charCodeAt(i);if(38===s&&i+1<t.length){i++;continue}const o=(this.charWidths[s]||Math.floor(this.image.width/16||8))*(this.letterSpacingMultiplier||1),r=i>0?t.charAt(i-1):"",n=i+1<t.length?t.charAt(i+1):"",a="."===String.fromCharCode(s)||"."===r||"."===n?this.periodSpacingMultiplier??.5:1,h="t"===r||"T"===r?this.tAfterSpacingMultiplier??1:1;this.eAndsSpacingMultiplier=this.eAndsSpacingMultiplier??.7;const l=r&&("e"===r.toLowerCase()||"s"===r.toLowerCase()),c=n&&("e"===n.toLowerCase()||"s"===n.toLowerCase()),d="e"===String.fromCharCode(s).toLowerCase()||"s"===String.fromCharCode(s).toLowerCase(),u=l||c||d?this.eAndsSpacingMultiplier??1:1;let f=1;if("number"==typeof this.doubleOneSpacingMultiplier&&"0.0.9a"===t){const e=String.fromCharCode(s),o=i+1<t.length?t.charAt(i+1):"";"1"===e&&"1"===o&&(f=this.doubleOneSpacingMultiplier)}const m="0.0.9a"===t,p="."===String.fromCharCode(s),g=m&&p&&this.periodGroupOffsetPx||0;e+=Math.round(o*(this.spacingMultiplier||1)*a*h*f*u)+g}return e}}export let PLACE_MAX_DISTANCE_BLOCKS=5;export let BLOCK_SELECTOR_FLASH_INTERVAL_MS=2e4;export function setBlockSelectorFlashInterval(t){BLOCK_SELECTOR_FLASH_INTERVAL_MS=Math.max(50,Number(t)||800)}export function getBlockSelectorFlashInterval(){return BLOCK_SELECTOR_FLASH_INTERVAL_MS}export function computeBlockTargetFromRay(t,e,i){try{if(!e||!i||0===i.length)return null;const s=e.intersectObjects(i,!0);if(!s||0===s.length)return null;const o=s[0],r=o.face.normal.clone(),n=(new THREE.Matrix3).getNormalMatrix(o.object.matrixWorld),a=r.applyMatrix3(n).normalize(),h=.01,l=o.point.clone().sub(a.clone().multiplyScalar(h));let c=Math.floor(l.x),d=Math.floor(l.y),u=Math.floor(l.z);a.y>.5&&(d=Math.floor(o.point.y-.5));let f=!1;for(let e=0;e<=6;e++){const i=d-e;if(i<0)break;if(0!==t.getTile(c,i,u)){d=i,f=!0;break}}if(!f)for(let e=-1;e<=1&&!f;e++)for(let i=-1;i<=1&&!f;i++)for(let s=0;s<=6;s++){const o=d-s,r=c+e,n=u+i;if(!(r<0||n<0||o<0||r>=t.width||n>=t.height||o>=t.depth)&&0!==t.getTile(r,o,n)){c=r,d=o,u=n,f=!0;break}}try{if(window.player&&"number"==typeof window.player.x){const t=window.player.x-(c+.5),e=window.player.y-(d+.5),i=window.player.z-(u+.5);if(Math.sqrt(t*t+e*e+i*i)>PLACE_MAX_DISTANCE_BLOCKS)return null}}catch(t){}return f?{x:c,y:d,z:u,normal:a,hitObject:o.object}:null}catch(t){return null}}export function placeOnTop(t,e,i,s,o={}){const r=!1!==o.forbidBedrock,n=t&&t.blockMaterials&&t.Tiles&&t.Tiles.bedrock&&t.Tiles.bedrock.id||8;if(e<0||i<0||e>=t.width||i>=t.height)return!1;try{if(window.player&&"number"==typeof window.player.x){const t=Math.abs(Math.floor(window.player.x)-e),s=Math.abs(Math.floor(window.player.z)-i);if(Math.sqrt(t*t+s*s)>PLACE_MAX_DISTANCE_BLOCKS)return!1}}catch(t){}let a=-1;for(let s=t.depth-1;s>=0;s--)if(0!==t.getTile(e,s,i)){a=s;break}let h=-1===a?0:a+1;if(h<0||h>=t.depth)return!1;if(r&&a>=0&&t.getTile(e,a,i)===n)return!1;if(0!==t.getTile(e,h,i))return!1;try{const s=window.player;if(s&&s.boundingBox)for(let o=h-1;o<=h+1;o++){if(o<0||o>=t.depth)continue;const r={minX:e,minY:o,minZ:i,maxX:e+1,maxY:o+1,maxZ:i+1};if(s.boundingBox.intersects(r))return!1}}catch(t){}t.setTile(e,h,i,s);try{const t=Tiles&&Tiles.stone&&Tiles.stone.id?Tiles.stone.id:1,o=Tiles&&Tiles.grass&&Tiles.grass.id?Tiles.grass.id:9;s!==t&&s!==o||playBreakSoundForTile(s,`place_sound_${e}_${h}_${i}`)}catch(t){}return"function"==typeof o.refreshCallback&&o.refreshCallback(e,h,i),!0}export function placeBelowBlock(t,e,i,s,o={}){const r=!1!==o.forbidBedrock,n=t&&t.blockMaterials&&t.Tiles&&t.Tiles.bedrock&&t.Tiles.bedrock.id||8;if(e<0||i<0||e>=t.width||i>=t.height)return!1;try{if(window.player&&"number"==typeof window.player.x){const t=Math.abs(Math.floor(window.player.x)-e),s=Math.abs(Math.floor(window.player.z)-i);if(Math.sqrt(t*t+s*s)>PLACE_MAX_DISTANCE_BLOCKS)return!1}}catch(t){}let a=-1;for(let s=t.depth-1;s>=0;s--)if(0!==t.getTile(e,s,i)){a=s;break}if(-1===a){const r=0;if(0!==t.getTile(e,r,i))return!1;try{const s=window.player;if(s&&s.boundingBox)for(let o=r-1;o<=r+1;o++){if(o<0||o>=t.depth)continue;const r={minX:e,minY:o,minZ:i,maxX:e+1,maxY:o+1,maxZ:i+1};if(s.boundingBox.intersects(r))return!1}}catch(t){}return t.setTile(e,r,i,s),"function"==typeof o.refreshCallback&&o.refreshCallback(e,r,i),!0}const h=a-1;if(h<0||h>=t.depth)return!1;if(0!==t.getTile(e,h,i))return!1;if(r&&t.getTile(e,a,i)===n)return!1;try{const s=window.player;if(s&&s.boundingBox)for(let o=h-1;o<=h+1;o++){if(o<0||o>=t.depth)continue;const r={minX:e,minY:o,minZ:i,maxX:e+1,maxY:o+1,maxZ:i+1};if(s.boundingBox.intersects(r))return!1}}catch(t){}return t.setTile(e,h,i,s),"function"==typeof o.refreshCallback&&o.refreshCallback(e,h,i),!0}export const placeOnBottom=placeBelowBlock;export function breakLowest(t,e,i,s={}){const o=!1!==s.forbidBedrock,r=t&&t.blockMaterials&&t.Tiles&&t.Tiles.bedrock&&t.Tiles.bedrock.id||8;if(e<0||i<0||e>=t.width||i>=t.height)return!1;let n=-1;for(let s=0;s<t.depth;s++)if(0!==t.getTile(e,s,i)){n=s;break}if(-1===n)return!1;const a=t.getTile(e,n,i);if(o&&a===r)return!1;try{playBreakSoundForTile(a,`breakLowest_${e}_${n}_${i}`)}catch(t){}t.setTile(e,n,i,0),"function"==typeof s.refreshCallback&&s.refreshCallback(e,n,i);try{s.particles&&"function"==typeof s.particles.burst&&s.particles.burst(e+.5,n+.5,i+.5,8,.2,s.particleTexture||null)}catch(t){}return!0}export function _playBreakSoundForTile(t){try{playBreakSoundForTile(t)}catch(t){}}export function breakBottom(t,e,i,s={}){const o=!1!==s.forbidBedrock,r=t&&t.blockMaterials&&t.Tiles&&t.Tiles.bedrock&&t.Tiles.bedrock.id||8;if(e<0||i<0||e>=t.width||i>=t.height)return!1;let n="number"==typeof s.targetY?s.targetY:null;if(null===n){let s=-1;for(let o=0;o<t.depth;o++)if(0!==t.getTile(e,o,i)){s=o;break}if(-1===s)return!1;n=s}if(n<0||n>=t.depth)return!1;const a=t.getTile(e,n,i);if(0===a)return!1;if(o&&a===r)return!1;try{_playBreakSoundForTile(a)}catch(t){}t.setTile(e,n,i,0),"function"==typeof s.refreshCallback&&s.refreshCallback(e,n,i);try{s.particles&&"function"==typeof s.particles.burst&&s.particles.burst(e+.5,n+.5,i+.5,8,.2,s.particleTexture||null)}catch(t){}return!0}export class Random{constructor(t){this.seed=BigInt(null==t?Math.floor(2147483647*Math.random()):t)}nextInt(t){this.seed=0x5deece66dn*this.seed+0xbn&(1n<<48n)-1n;const e=2147483647&Number(this.seed>>16n);return t?e%t:e}nextFloat(){return this.nextInt(2147483647)/2147483647}}export let LAVA_SEED_ATTEMPTS=400;export let LAVA_DEPTH_FRACTION=.25;export let CAVE_DENSITY_MULT=1;function _idx(t,e,i,s){const o=t.width,r=t.depth,n=t.height;return e<0||e>=o||s<0||s>=n||i<0||i>=r?-1:e+(r-1-i)*o+s*(o*r)}export function applySeedFeatures(t,e=null){try{const i=new Random(null==e?Math.floor(2147483647*Math.random()):e),s=t.width,o=t.height,r=t.depth,n=window.Tiles&&Tiles.stone&&Tiles.stone.id?Tiles.stone.id:1,a=Math.max(1,Math.floor(s*o*r/256/64*CAVE_DENSITY_MULT));for(let e=0;e<a;e++){let e=i.nextFloat()*s,a=i.nextFloat()*r,h=i.nextFloat()*o,l=Math.floor(150*i.nextFloat())+1,c=i.nextFloat()*Math.PI*2,d=0,u=i.nextFloat()*Math.PI*2,f=0;for(let m=0;m<l;m++){e+=Math.sin(c)*Math.cos(u),h+=Math.cos(c)*Math.cos(u),a+=Math.sin(u),c+=.2*d,d*=.9,d+=i.nextFloat()-i.nextFloat(),u+=.5*f,f*=.5,f+=i.nextFloat()-i.nextFloat();let p=2.5*Math.sin(m*Math.PI/l)+1;const g=Math.floor(e-p),y=Math.floor(e+p),w=Math.floor(a-p),b=Math.floor(a+p),M=Math.floor(h-p),x=Math.floor(h+p);for(let i=g;i<=y;i++)for(let l=w;l<=b;l++)for(let c=M;c<=x;c++){if(i<=0||l<=0||c<=0||i>=s-1||l>=r-1||c>=o-1)continue;const d=i-e,u=l-a,f=c-h;if(d*d+u*u*2+f*f<p*p){const e=_idx(t,i,l,c);e>=0&&t.blocks[e]===n&&(t.blocks[e]=0)}}}}return!0}catch(t){return console.warn("applySeedFeatures error",t),!1}}export const ARM_IN_DEG=100;export const LEG_LIMIT_DEG=35;export const ARM_SWING_SPEED=.9;export const JITTER_MAG=3;export const JITTER_TIME_SCALE=.35;export const HEAD_JITTER_MAG=6;export function q(t){const e=2*Math.PI;let i=(t%e+e)%e;const s=Math.floor(i/(e/3));return 0===s?-1:1===s?0:1}function jitter(t=0,e=JITTER_MAG){return(.5*Math.sin((t||0)*JITTER_TIME_SCALE)+.2*(Math.random()-.5))*e*(Math.PI/180)}export function computeZombiePose(t){const e=100*Math.PI/180,i=35*Math.PI/180,s=.9*t,o=q(s),r=q(s+Math.PI),n={xRot:1.2*o+jitter(t),zRot:-Math.abs(o)*e+jitter(t)},a={xRot:1.2*r+jitter(t),zRot:+Math.abs(r)*e+jitter(t)};let h=o*i+jitter(t),l=r*i+jitter(t);h=Math.max(-i,Math.min(i,h)),l=Math.max(-i,Math.min(i,l));const c=1*Math.sin(.83*t)+.5*jitter(t,6);return{arm0:n,arm1:a,leg0Rad:h,leg1Rad:l,headPitchRad:.8*Math.sin(t)+.5*jitter(t,6),headYawRad:c}}export class NoiseGenerator{generateNoise(t,e){throw new Error("NoiseGenerator.generateNoise() must be implemented by subclasses.")}generate3D(t,e,i){return this.generateNoise(t,e)}}export class Zombie extends Entity{constructor(t,e,i,s,...o){super(t),this.setPos(e,i,s),this.rot=Math.random()*Math.PI*2,this.timeOffs=1239813*Math.random(),this.speed=config.zombie.baseSpeed,this.rotA=.0015*(Math.random()+1),this.walkSpeedFactor=config.zombie.walkSpeedFactor,this._stuckTimer=0,this._lastStuckCheck=performance.now(),this._lastPos={x:this.x,z:this.z},this._unstickCooldown=0,this.group=new THREE.Group,this.modelGroup=null,this._gltfReady=!1,this._mixer=null,this._mixerTimeScale=1/12,this._lastMixerTime=performance.now(),this._actions=[],this.headNode=null,this._headSnapTimer=0,this._headSnapInterval=.7,this._headTargetPitch=0,this._headTargetYaw=0,this._mixerBaseSpeed=1/12,this.group.position.set(this.x,this.y,this.z),this.group.visible=!0,this.group.name="ZombieGroup";try{loadGLTFLoader().then((t=>{try{const e=new t,i=["../res/a.glb"],s=t=>{if(t>=i.length)return void this._ensureFallbackMesh();const o=i[t];e.load(o,(t=>{try{if(this.modelGroup=t.scene||t.scenes?.[0]||null,this.modelGroup&&(this.modelGroup.traverse((t=>{t.isMesh&&(t.frustumCulled=!1,t.castShadow=!1,t.receiveShadow=!1,t.material&&(t.material.toneMapped=!1,t.material.needsUpdate=!0))})),this.modelGroup.traverse((t=>{if(!t.isMesh||!t.material)return;const e=Array.isArray(t.material)?t.material:[t.material];for(const i of e)try{"metalness"in i&&(i.metalness=0),"roughness"in i&&(i.roughness=1),"envMap"in i&&(i.envMap=null),"envMapIntensity"in i&&(i.envMapIntensity=0),i.color&&i.color.setScalar(1),i.needsUpdate=!0}catch(t){}})),this.modelGroup.scale.setScalar(1.16666668),this.modelGroup.rotation.x=Math.PI,this.modelGroup.position.set(0,0,0),this.group.add(this.modelGroup),this._pendingScene&&!this.group.parent&&this._pendingScene.add(this.group),this._gltfReady=!0),t.animations&&t.animations.length>0&&this.modelGroup){this._gltfClips=t.animations;try{this._mixer=new THREE.AnimationMixer(this.modelGroup);for(let t=0;t<this._gltfClips.length;t++){const e=this._gltfClips[t],i=this._mixer.clipAction(e);i.reset(),i.play(),i.setEffectiveWeight(0),this._actions.push(i)}this._mixer.timeScale=this._mixerTimeScale,this._lastMixerTime=performance.now()}catch(t){console.warn("[Zombie] mixer init failed",t)}}}catch(t){console.error("[Zombie] post-load error",t),this._ensureFallbackMesh()}}),void 0,(e=>{console.warn("[Zombie] GLB load failed at",o,e),s(t+1)}))};s(0)}catch(t){console.error("[Zombie] GLTFLoader usage failed",t),this._ensureFallbackMesh()}})).catch((t=>{console.error("[Zombie] GLTFLoader unavailable",t),this._ensureFallbackMesh()}))}catch(t){console.error("[Zombie] loader bootstrap failed",t),this._ensureFallbackMesh()}this._ensureFallbackMesh=this._ensureFallbackMesh||(()=>{if(!this._fallbackReady){this._fallbackReady=!0;try{const t=new THREE.BoxGeometry(.6,1.2,.3),e=new THREE.MeshBasicMaterial({color:5635925}),i=new THREE.Mesh(t,e);i.position.set(0,.6,0),i.frustumCulled=!1,i.name="ZombieFallback",this.group.add(i),this._pendingScene&&!this.group.parent&&this._pendingScene.add(this.group)}catch(t){}}})}render(t){if(this.removed)return;const e=Date.now()/100*Math.max(.5,this.speed)+this.timeOffs,i=5*-Math.abs(Math.sin(.6662*e))-23,s=this.xo+(this.x-this.xo)*t,o=this.yo+(this.y-this.yo)*t,r=this.zo+(this.z-this.zo)*t;if(this.group.position.set(s,o-.05,r),this.group.scale.set(1,1,1),this.group.rotation.set(Math.PI,this.rot+Math.PI,0),this._mixer){const e=performance.now(),i=(e-(this._lastMixerTime||e))/1e3,s=Math.min(i,.1);try{this._mixer.update(s)}catch(t){}this._lastMixerTime=e}if(this._gltfReady&&this.modelGroup){this.modelGroup.position.y=.01*i+0;const t=computeZombiePose(Date.now()/1e3*4.285714+this.timeOffs);this.modelGroup.traverse((e=>{if(!e||!e.name)return;const i=e.name.toLowerCase();if(i.includes("head")||i.includes("skull"))return e.rotation.x=t.headPitchRad,e.rotation.y=t.headYawRad,void(this.headNode||(this.headNode=e));if(i.includes("arm")||i.includes("hand")){const s=/left|_l|\.l|arm0|arm_l/.test(i),o=s?t.arm0:t.arm1;o?(e.rotation.x=o.xRot||0,e.rotation.y=0,e.rotation.z=(s?-1:1)*(o.zRot||0)):(e.rotation.x=0,e.rotation.y=0,e.rotation.z=0)}else if(i.includes("leg")||i.includes("foot")){const s=/left|_l|\.l|leg0|leg_l/.test(i)?t.leg0Rad:t.leg1Rad;e.rotation.x=s||0,e.rotation.y=0,e.rotation.z=0}}))}}addToScene(t){this._pendingScene=t,this.group.parent||t.add(this.group),this.group.visible=!0,this._pathLine&&!this._pathLine.parent&&t.add(this._pathLine),this._pathLine&&(this._pathLine.visible=!!window.showZombiePaths)}removeFromScene(t){if(t.remove(this.group),this._pathLine&&t){t.remove(this._pathLine);try{this._pathLine.geometry.dispose(),this._pathLine.material.dispose()}catch(t){}this._pathLine=null}}setPathVisibility(t){window.showZombiePaths=!!t,this._pathLine&&(this._pathLine.visible=!!t)}_generatePath(){if(!this.level)return;const t=config.pathfinding.maxSteps,e=Math.floor(this.x),i=Math.floor(this.z);this.level.getGroundHeight(e,i);let s=e,o=i;const r=Math.random()*Math.PI*2;for(let e=0;e<t;e++){const t=r+.6*(Math.random()-.5),i=e<4?1:2,n=s+Math.round(Math.cos(t)*i),a=o+Math.round(Math.sin(t)*i);if(n<0||a<0||n>=(this.level?this.level.width:0)||a>=(this.level?this.level.height:0))break;const h=this.level.getGroundHeight?this.level.getGroundHeight(n,a):-1,l=h+1;if(l>=0&&l<(this.level?this.level.depth:0)&&0===this.level.getTile(n,l,a))return{angle:Math.atan2(Math.cos(t),Math.sin(t)),targetY:h}}return null}_updatePathLine(t=!1){try{const t=!!window.showZombiePaths;if(this._pathVisible=t,!this.group)return;this._pathLine&&this._pathLine.parent&&(this._pathLine.visible=t)}catch(t){}}_findOpenDirection(){if(!this.level)return null;const t=Math.floor(this.x),e=Math.floor(this.z);for(let i=1;i<=3;i++)for(let s=0;s<16;s++){const o=s/16*Math.PI*2,r=Math.floor(t+Math.round(Math.cos(o)*i)),n=Math.floor(e+Math.round(Math.sin(o)*i));if(r<0||n<0||r>=(this.level?this.level.width:0)||n>=(this.level?this.level.height:0))continue;const a=this.level.getGroundHeight?this.level.getGroundHeight(r,n):-1,h=a+1;if(h>=0&&h<(this.level?this.level.depth:0)&&0===this.level.getTile(r,h,n))return{angle:Math.atan2(Math.cos(o),Math.sin(o)),targetY:a}}return null}}Zombie.prototype._playerLikeJump=function(){const t=60*config.player.gravityPerTick,e="number"==typeof config.player.jumpHeightCapBlocks?config.player.jumpHeightCapBlocks:config.player.maxJumpHeightBlocks,i=Math.sqrt(2*t*e),s=window.game&&"number"==typeof window.game.lastDisplayedFPS?window.game.lastDisplayedFPS:null;let o=1;return null!==s&&(s<40?o=3:s<50?o=2:s<70&&(o=1.5)),Math.min(this.jumpSpeed*o,i)};try{if("undefined"!=typeof window&&!window._zombieTickerRunning){window._zombieTickerRunning=!0;let e=performance.now();const i=()=>{const t=performance.now(),s=Math.min(.1,(t-e)/1e3);e=t;try{const e=window.game,i=e&&Array.isArray(e.zombies)?e.zombies:null;if(i)for(let e=i.length-1;e>=0;e--){const o=i[e];try{o&&"function"==typeof o.tick&&o.tick(s)}catch(t){}try{o&&"function"==typeof o.render&&o.render(1)}catch(t){}}}catch(t){}requestAnimationFrame(i)};requestAnimationFrame(i)}}catch(s){}export class Player{constructor(t,e,i){this.scene=t,this.camera=e,this.world=i,this.invertMouseY=!1,this.leanEnabled=!1,this.x=0,this.y=0,this.z=0,this.prevX=0,this.prevY=0,this.prevZ=0,this.motionX=0,this.motionY=0,this.motionZ=0,this.walkSpeed=config.player.walkSpeed,this.jumpSpeed=config.player.jumpSpeed,this.xRotation=0,this.yRotation=0,this.onGround=!1,this.width=.3,this.height=.9,this.boundingBox=new AABB(0,0,0,0,0,0),this.controls={forward:!1,backward:!1,left:!1,right:!1,jump:!1},this.onMouseMove=this.onMouseMove.bind(this),this.group=new THREE.Group,this.modelGroup=null,this.headNode=null,this.headSnapInterval=.7,this._headSnapTimer=0,this._headTargetPitch=0,this._headTargetYaw=0,this._mixer=null,this._actions=[],this._mixerBaseSpeed=1/12,this._crawlState=!1,this.lockCamToHeadForMovement=!1,this.cameraPitch=0,t.add(this.group),this.initControls(),this.initPointerLock(),this.resetPosition(),this.initPlayerModel()}initControls(){document.addEventListener("keydown",(t=>{if(!window.chatTyping)switch(t.code){case"KeyW":case"ArrowUp":this.controls.forward=!0;break;case"KeyS":case"ArrowDown":this.controls.backward=!0;break;case"KeyA":case"ArrowLeft":this.controls.left=!0;break;case"KeyD":case"ArrowRight":this.controls.right=!0;break;case"KeyG":(async()=>{try{const{Zombie:t}=await import("./c.js"),e=this.y-1.62,i=new t(this.world,this.x,e+1,this.z,null);window.game&&Array.isArray(window.game.zombies)&&window.game.zombies.push(i),window.entities=window.entities||[],window.entities.push(i),i.addToScene&&i.addToScene(this.scene),"function"==typeof i.setPathVisibility&&i.setPathVisibility(!!window.showZombiePaths)}catch(t){console.warn("Spawn zombie failed",t)}})();break;case"Space":this.controls.jump=!0;break;case"KeyR":this.resetPosition();break;case"Digit7":if(window.showZombiePaths=!window.showZombiePaths,window.game&&Array.isArray(window.game.zombies))for(const e of window.game.zombies)try{e&&"function"==typeof e.setPathVisibility&&e.setPathVisibility(window.showZombiePaths)}catch(t){}if(window.entities&&Array.isArray(window.entities))for(const e of window.entities)try{e&&"function"==typeof e.setPathVisibility&&e.setPathVisibility(window.showZombiePaths)}catch(t){}break;case"Digit8":this.thirdPerson&&(this.thirdPersonFront=!this.thirdPersonFront);break;case"Digit1":this.thirdPerson=!1;try{const t=document.getElementById("crosshair");t&&(t.style.display="")}catch(t){}break;case"Digit9":this.leanEnabled=!this.leanEnabled,this.leanEnabled||(this.xRotation=Math.max(-90,Math.min(90,this.xRotation)))}})),document.addEventListener("keyup",(t=>{if(!window.chatTyping)switch(t.code){case"KeyW":case"ArrowUp":this.controls.forward=!1;break;case"KeyS":case"ArrowDown":this.controls.backward=!1;break;case"KeyA":case"ArrowLeft":this.controls.left=!1;break;case"KeyD":case"ArrowRight":this.controls.right=!1;break;case"Space":this.controls.jump=!1}}))}initPointerLock(){const t=document.getElementById("canvas");t&&(t.addEventListener("click",(()=>{t.requestPointerLock&&t.requestPointerLock()})),document.addEventListener("pointerlockchange",(()=>{document.pointerLockElement===t?document.addEventListener("mousemove",this.onMouseMove,!1):document.removeEventListener("mousemove",this.onMouseMove,!1)})))}initPlayerModel(){try{(new GLTFLoader).load("../res/a.glb",(t=>{this.modelGroup=t.scene||t.scenes?.[0]||null;try{window._steveGLTF=t}catch(t){}if(this.modelGroup){this.headNode=this.modelGroup.getObjectByName("head")||this.modelGroup.getObjectByName("Head")||null,this.headNode||this.modelGroup.traverse((t=>{!this.headNode&&t.name&&/head/i.test(t.name)&&(this.headNode=t)}));const e=new THREE.AmbientLight(16777215,.3);if(this.modelGroup.add(e),this.modelGroup.traverse((t=>{t.isMesh&&(t.castShadow=!1,t.receiveShadow=!1)})),this.modelGroup.traverse((t=>{if(!t.isMesh)return;const e=t=>{try{t.color&&t.color.lerp(new THREE.Color(16777215),.08),t.emissive&&t.emissive.setHex(0),"metalness"in t&&(t.metalness=0),"metalnessMap"in t&&(t.metalnessMap=null),"roughness"in t&&(t.roughness=Math.max(.9,t.roughness||1)),"roughnessMap"in t&&(t.roughnessMap=null),"envMap"in t&&(t.envMap=null),"envMapIntensity"in t&&(t.envMapIntensity=0),"clearcoat"in t&&(t.clearcoat=0),"clearcoatMap"in t&&(t.clearcoatMap=null);try{const e=Math.floor(this.x||0),i=Math.floor(this.z||0),s=Math.max(0,Math.floor((this.y||0)-1)),o=this.world&&"function"==typeof this.world.getBrightness?this.world.getBrightness(e,s,i,0).finalBrightness:1;t.color&&t.color.setScalar(1),t.color&&t.color.multiplyScalar(o),t.needsUpdate=!0}catch(t){}}catch(t){}};Array.isArray(t.material)?t.material.forEach(e):t.material&&e(t.material)})),this.modelGroup.traverse((t=>{if(!t||!t.name)return;const e=t.name.toLowerCase();try{/arm|hand/.test(e)?t.rotation.z=(t.rotation.z||0)+.45*(/left/.test(e)?-1:1):/leg|thigh|foot/.test(e)?t.rotation.x=(t.rotation.x||0)+.15:/head|skull/.test(e)&&(t.rotation.x=(t.rotation.x||0)+.08)}catch(t){}})),this.modelGroup.scale.setScalar(.95),this.modelGroup.rotation.x=Math.PI,this.modelGroup.visible=!1,t.animations&&t.animations.length>0)try{this._mixer=new THREE.AnimationMixer(this.modelGroup),this._actionsByName={};for(let e=0;e<t.animations.length;e++){const i=t.animations[e],s=this._mixer.clipAction(i);s.play(),s.setEffectiveWeight(0),this._actions.push(s),i&&i.name&&(this._actionsByName[i.name]=s)}if(!this._actionsByName["animation.steve.idle"])for(const t in this._actionsByName)if(/idle/i.test(t)){this._actionsByName["animation.steve.idle"]=this._actionsByName[t];break}}catch(t){}}}),void 0,(()=>{}))}catch(t){}}onMouseMove(t){if(!t)return;const e=t.movementX||0,i=(t.movementY||0)*(this.invertMouseY?-1:1);this.yRotation-=e*config.player.mouseSensitivity.x;const s=config.player.mouseSensitivity.y;this.thirdPerson?this.cameraPitch-=i*s:this.xRotation-=i*s;const o=config.camera.maxFirstPitch;this.xRotation=Math.max(-o,Math.min(o,this.xRotation)),this.cameraPitch=Math.max(-config.camera.maxThirdPitch,Math.min(config.camera.maxThirdPitch,this.cameraPitch)),this.camera.rotation.order="YXZ",this.camera.rotation.set(THREE.MathUtils.degToRad(this.xRotation),THREE.MathUtils.degToRad(this.yRotation),0)}resetPosition(){const t=Math.random()*this.world.width,e=Math.random()*this.world.height,i=this.world.getGroundHeight(Math.floor(t),Math.floor(e))+2;this.setPosition(t,i,e)}update(t){this.tick(t)}tick(t=1/60){this.prevX=this.x,this.prevY=this.y,this.prevZ=this.z,this.modelGroup&&(this.modelGroup.visible=!!this.thirdPerson);const e=this.leanEnabled&&this.xRotation<-50;e!==this._crawlState&&(this._crawlState=e,this._crawlState?(this.width=.18,this.height=.45):(this.width=.3,this.height=.9),this._updateBoundingBoxDims());let i=0,s=0;this.controls.forward&&(s+=this.thirdPerson?1:-1),this.controls.backward&&(s-=this.thirdPerson?1:-1);const o=this.thirdPerson?-1:1;if(this.controls.left&&(i-=1*o),this.controls.right&&(i+=1*o),this.controls.jump&&this.onGround){const t=60*config.player.gravityPerTick,e="number"==typeof config.player.jumpHeightCapBlocks?config.player.jumpHeightCapBlocks:config.player.maxJumpHeightBlocks,i=Math.sqrt(2*t*e),s=window.game&&"number"==typeof window.game.lastDisplayedFPS?window.game.lastDisplayedFPS:null;let o=1;null!==s&&(s<40?o=3:s<50?o=2:s<70&&(o=1.5));const r=Math.min(this.jumpSpeed*o,i);this.motionY=r}const r=this.onGround?this.walkSpeed:.2*this.walkSpeed;this.moveRelative(i,s,r,t);const n=60*config.player.gravityPerTick;this.motionY-=n*t,this.move(this.motionX,this.motionY,this.motionZ);const a=60*t,h=Math.pow(.91,a),l=Math.pow(.98,a);if(this.motionX*=h,this.motionY*=l,this.motionZ*=h,this.onGround){const t=Math.pow(.8,a);this.motionX*=t,this.motionZ*=t}if(this._mixer){const e=Math.sqrt(this.motionX*this.motionX+this.motionZ*this.motionZ);if(e>.01){const i=1+Math.min(4,30*e);this._mixer.timeScale=this._mixerBaseSpeed*i;const s=Math.min(1,6*e);for(let t=0;t<this._actions.length;t++)this._actions[t].setEffectiveWeight(0===t?s:.6*s);try{this._mixer.update(t)}catch(t){}}else{const t=this._actionsByName&&(this._actionsByName["animation.steve.idle"]||this._actionsByName.idle)||null;if(t)for(let e=0;e<this._actions.length;e++){const i=this._actions[e];i.setEffectiveWeight(i===t?1:0)}else for(let t of this._actions)t.setEffectiveWeight(0)}}if(this.modelGroup){this.modelGroup.rotation.x=Math.PI,this.modelGroup.rotation.z=this.thirdPerson?Math.PI:0;try{const t=Math.floor(this.x||0),e=Math.floor(this.z||0),i=Math.max(0,Math.floor((this.y||0)-1)),s=this.world&&"function"==typeof this.world.getBrightness?this.world.getBrightness(t,i,e,0).finalBrightness:1;this.modelGroup.traverse((t=>{if(!t.isMesh||!t.material)return;const e=Array.isArray(t.material)?t.material:[t.material];for(const i of e)try{i.color&&(i.color.setScalar(1),i.color.multiplyScalar(s),i.needsUpdate=!0)}catch(t){}}))}catch(t){}}if(this.thirdPerson){const t=config.camera.thirdPersonDistance,e=config.camera.heightOffset;if(this.modelGroup&&this.headNode){if(this.thirdPerson&&this.xRotation>85){this.thirdPersonTopDown=!0;const t=10;this.camera.position.set(this.x,this.y+t,this.z),this.camera.lookAt(new THREE.Vector3(this.x,this.y,this.z)),this.lockCamToHeadForMovement&&(this.yRotation=this.yRotation)}else this.thirdPersonTopDown&&this.xRotation<=85&&(this.thirdPersonTopDown=!1);if(!this.thirdPersonTopDown){this.headNode.updateWorldMatrix(!0,!1);const i=new THREE.Vector3;this.headNode.getWorldPosition(i);const s=THREE.MathUtils.degToRad(this.yRotation),o=this.thirdPersonFront?1:-1,r=o*Math.sin(s)*t,n=o*Math.cos(s)*t;this.camera.position.set(i.x+r,i.y+e,i.z+n);const a=THREE.MathUtils.degToRad(this.cameraPitch||0),h=i.clone();h.y+=Math.tan(a)*Math.max(.001,t),this.camera.lookAt(h),this.lockCamToHeadForMovement}}else{const e=THREE.MathUtils.degToRad(this.yRotation),i=-Math.sin(e)*t,s=-Math.cos(e)*t;this.camera.position.set(this.x+i,this.y+1.5,this.z+s),this.camera.lookAt(new THREE.Vector3(this.x,this.y,this.z))}}else this.camera.position.set(this.x,this.y,this.z);this.group&&(this.group.position.set(this.x,this.y-1.62+.05,this.z),this.group.rotation.y=THREE.MathUtils.degToRad(this.yRotation+180))}_updateBoundingBoxDims(){const t=this.width,e=this.height;this.boundingBox=new AABB(this.x-t,this.y-e,this.z-t,this.x+t,this.y+e,this.z+t)}moveRelative(t,e,i,s){s=Math.max(0,s||1/60);let o=t*t+e*e;if(o>=.01){const r=i*s/Math.sqrt(o),n=t*r,a=e*r,h=THREE.MathUtils.degToRad(this.yRotation),l=Math.sin(h),c=Math.cos(h);this.motionX+=a*l+n*c,this.motionZ+=a*c-n*l}}move(t,e,i){let s=t,o=e,r=i;const n=this.boundingBox.expand(t,e,i),a=this.world.getCubes(n);for(const t of a)e=t.clipYCollide(this.boundingBox,e);this.boundingBox.move(0,e,0);for(const e of a)t=e.clipXCollide(this.boundingBox,t);this.boundingBox.move(t,0,0);for(const t of a)i=t.clipZCollide(this.boundingBox,i);this.boundingBox.move(0,0,i),this.onGround=o!==e&&o<0,s!==t&&(this.motionX=0),o!==e&&(this.motionY=0),r!==i&&(this.motionZ=0),this.x=(this.boundingBox.minX+this.boundingBox.maxX)/2,this.y=this.boundingBox.minY+1.62,this.z=(this.boundingBox.minZ+this.boundingBox.maxZ)/2}setPosition(t,e,i){this.x=t,this.y=e,this.z=i;const s=this.width,o=this.height;this.boundingBox=new AABB(t-s,e-o,i-s,t+s,e+o,i+s),this.camera.position.set(this.x,this.y,this.z)}}function quantize3Sine(t){const e=2*Math.PI;let i=(t%e+e)%e;const s=Math.floor(i/(e/3));return 0===s?-1:1===s?0:1}function updateArms(t){const e=3/.7,i=.6662*t*e,s=.2812*t*e,o=.5*(quantize3Sine(.2312*t*e)+1);return{arm0:{xRot:1.6*quantize3Sine(i+Math.PI),zRot:(r=o,0,1,Math.max(0,Math.min(1,r)))},arm1:{xRot:1.6*quantize3Sine(i),zRot:Math.max(quantize3Sine(s),0)?1:0}};var r}Player.prototype.a=Player.prototype.initControls,Player.prototype.b=Player.prototype.initPointerLock,Player.prototype.c=Player.prototype.initPlayerModel,Player.prototype.d=Player.prototype.onMouseMove,Player.prototype.e=Player.prototype.resetPosition,Player.prototype.f=Player.prototype.update,Player.prototype.g=Player.prototype.tick,Player.prototype.h=Player.prototype._updateBoundingBoxDims,Player.prototype.i=Player.prototype.moveRelative,Player.prototype.j=Player.prototype.move,Player.prototype.k=Player.prototype.setPosition;export function initChat(){try{const t=document.getElementById("chat-log");if(!t)return;if("1"===t.dataset._inited)return;t.dataset._inited="1",t.textContent="";const e=document.createElement("div");e.style.whiteSpace="pre-wrap",e.style.margin="2px 0",e.style.fontFamily="Noto Sans, monospace",e.style.fontSize="16px",e.style.color="#fff",e.style.textShadow="2px 2px 0 rgba(0,0,0,0.8)";const i=document.createElement("span");i.textContent="[SERVER] ",i.style.color="yellow",i.style.fontWeight="700";const s=document.createElement("span");s.textContent="Made By STG (https://github.com/cavegamedev)",e.appendChild(i),e.appendChild(s),t.appendChild(e),setTimeout((()=>{e.style.transition="opacity 1s",e.style.opacity="0",setTimeout((()=>e.remove()),1e3)}),15e3)}catch(t){}}