const ID_STONE=1,ID_DIRT=2,ID_GRASS=9;Math.seedrandom||(Math.seedrandom=function(t){let o=2147483647;return t=t||1,function(){return(t=(16807*t+0)%o)/o}});class NoiseMap{constructor(t){this.levels=t,this.fuzz=16,this.seed=Math.floor(2147483647*Math.random())}read(t,o){const e=new Math.seedrandom(this.seed),r=new Int32Array(t*o);let a=this.levels,f=t>>a;for(let a=0;a<o;a+=f)for(let o=0;o<t;o+=f)r[o+a*t]=(Math.floor(256*e())-128)*this.fuzz;for(;f>1;){const n=256*(f<<a),l=Math.floor(f/2);for(let a=0;a<o;a+=f)for(let s=0;s<t;s+=f){const h=r[(s+0)%t+(a+0)%o*t],M=r[(s+f)%t+(a+0)%o*t],c=r[(s+0)%t+(a+f)%o*t],i=r[(s+f)%t+(a+f)%o*t],d=Math.floor((h+c+M+i)/4)+Math.floor(e()*n*2)-n;r[s+l+(a+l)*t]=d}for(let a=0;a<o;a+=f)for(let s=0;s<t;s+=f){const h=r[s+a*t],M=r[(s+f)%t+a*t],c=r[s+(a+f)%o*t],i=r[(s+l&t-1)+(a+l-f&o-1)*t],d=r[(s+l-f&t-1)+(a+l&o-1)*t],u=r[(s+l)%t+(a+l)%o*t],w=Math.floor((h+M+u+i)/4)+Math.floor(e()*n*2)-n,p=Math.floor((h+c+u+d)/4)+Math.floor(e()*n*2)-n;r[s+l+a*t]=w,r[s+(a+l)*t]=p}f=Math.floor(f/2)}const n=new Int32Array(t*o);for(let e=0;e<o;e++)for(let a=0;a<t;a++)n[a+e*t]=Math.floor(r[a%t+e%o*t]/512)+128;return n}}onmessage=function(t){const o=t.data.width||256,e=t.data.height||256,r=t.data.depth||64,a=new Uint8Array(o*r*e),f=new Uint8Array(o*e),n=new NoiseMap(0).read(o,e),l=new NoiseMap(0).read(o,e),s=new NoiseMap(1).read(o,e),h=new NoiseMap(1).read(o,e);for(let t=0;t<o;t++)for(let f=0;f<e;f++){let e=n[t+f*o],M=l[t+f*o];s[t+f*o]<128&&(M=e);let c=Math.max(e,M),i=Math.min(r-1,Math.floor(c/8)+Math.floor(r/3)),d=Math.floor(h[t+f*o]/8)+Math.floor(r/3);d>i-2&&(d=i-2);const u=30,w=Math.min(Math.floor(r/3),u);i<=w&&(i=w+1);for(let e=0;e<r;e++){const n=r-1-e,l=t+e*o+f*(o*r);let s=0;0!==n?(n===i&&n>w?s=9:n<i&&n>=d?s=2:n<d&&(s=1),a[l]=s):(s=1,a[l]=s)}}const M=Math.floor(o*e*r/256/64),c=new Math.seedrandom(Date.now());for(let t=0;t<M;t++){let t=c()*o,f=c()*r,n=c()*e;const l=Math.floor(c()+150*c());let s=c()*Math.PI*2,h=0,M=c()*Math.PI*2,i=0;for(let d=0;d<l;d++){t+=Math.sin(s)*Math.cos(M),n+=Math.cos(s)*Math.cos(M),f+=Math.sin(M),s+=.2*h,h*=.9,h+=c()-c(),M+=.5*i,M*=.5,i*=.9,i+=c()-c();const u=2.5*Math.sin(d*Math.PI/l)+1;for(let l=Math.floor(t-u);l<=Math.floor(t+u);l++)for(let s=Math.floor(f-u);s<=Math.floor(f+u);s++)for(let h=Math.floor(n-u);h<=Math.floor(n+u);h++){const M=l-t,c=s-f,i=h-n;if(M*M+c*c*2+i*i<u*u&&l>=1&&s>=1&&h>=1&&l<o-1&&s<r-1&&h<e-1){const t=l+s*o+h*(o*r);1===a[t]&&(a[t]=0)}}}}try{const t=new Uint8Array(o*e);for(let f=0;f<o;f++)for(let n=0;n<e;n++){let e=-1;for(let t=r-1;t>=0;t--)if(0!==a[f+t*o+n*(o*r)]){e=t;break}if(e>=0){const l=f+n*o;1===a[f+e*o+n*(o*r)]&&(t[l]=1)}}const f=new Uint8Array(o*e),n=[];for(let l=0;l<o;l++)for(let s=0;s<e;s++){const h=l+s*o;if(!t[h]||f[h])continue;let M=0;n.push([l,s]),f[h]=1;const c=[];let i=l,d=l,u=s,w=s;for(;n.length;){const[r,a]=n.pop();if(!t[r+a*o])continue;M++,c.push([r,a]),r<i&&(i=r),r>d&&(d=r),a<u&&(u=a),a>w&&(w=a);const l=[[1,0],[-1,0],[0,1],[0,-1]];for(const[s,h]of l){const l=r+s,M=a+h;if(l<0||M<0||l>=o||M>=e)continue;const c=l+M*o;!f[c]&&t[c]&&(f[c]=1,n.push([l,M]))}}if(M>=10||d-i+1>=10)for(const[t,e]of c)for(let f=r-1;f>=0;f--){const n=t+f*o+e*(o*r);if(0!==a[n]){1===a[n]&&(a[n]=9);break}}}}catch(t){}for(let t=0;t<o;++t)for(let n=0;n<e;++n){let e;for(e=r-1;e>=0&&0===a[t+e*o+n*(o*r)];--e);f[t+n*o]=e<0?-1:r-1-e}postMessage({blocks:a.buffer,lightDepths:f.buffer,width:o,height:e,depth:r},[a.buffer,f.buffer])};